// Canvas'ƒ± temizle
             ctx.clearRect(0, 0, width, height);
             
             // Daha ger√ßek√ßi fiyat verisi olu≈ütur (25 nokta)
             const dataPoints = 25;
             const priceData = [];
             let basePrice = parseFloat(currentPrice) || 45000;
             
             // Crypto volatility ve momentum simulation
             let momentum = 0;
             let currentPricePoint = basePrice;
             
             for (let i = 0; i < dataPoints; i++) {
                 // Realistic crypto volatility (%1.5)
                 const volatility = (Math.random() - 0.5) * 0.015;
                 
                 // Market trend (subtle sine wave)
                 const marketTrend = Math.sin((i / dataPoints) * Math.PI * 1.5) * 0.008;
                 
                 // Momentum factor (simulates buying/selling pressure)
                 momentum = momentum * 0.7 + (Math.random() - 0.5) * 0.005;
                 
                 // Random walk with mean reversion
                 const meanReversion = (basePrice - currentPricePoint) / basePrice * 0.1;
                 
                 // Combine all factors
                 const priceChange = volatility + marketTrend + momentum + meanReversion;
                 currentPricePoint *= (1 + priceChange);
                 
                 // Ensure price doesn't go negative or too extreme
                 currentPricePoint = Math.max(currentPricePoint, basePrice * 0.85);
                 currentPricePoint = Math.min(currentPricePoint, basePrice * 1.15);
                 
                 priceData.push(currentPricePoint);
             }
             
             // Calculate trend and price range
             const minPrice = Math.min(...priceData);
             const maxPrice = Math.max(...priceData);
             const priceRange = maxPrice - minPrice || 1; // Prevent division by zero
             const isUpTrend = priceData[priceData.length - 1] > priceData[0];
             const trendStrength = Math.abs(priceData[priceData.length - 1] - priceData[0]) / priceData[0];
             
             // Professional color scheme
             const trendColor = isUpTrend ? '#00E676' : '#FF5252'; // Material Design colors
             const trendColorRGB = isUpTrend ? '0, 230, 118' : '255, 82, 82';
             
             // Create sophisticated gradient
             const fillGradient = ctx.createLinearGradient(0, padding, 0, height - padding);
             fillGradient.addColorStop(0, `rgba(${trendColorRGB}, ${0.35 + trendStrength * 0.2})`);
             fillGradient.addColorStop(0.6, `rgba(${trendColorRGB}, ${0.15 + trendStrength * 0.1})`);
             fillGradient.addColorStop(1, `rgba(${trendColorRGB}, 0.02)`);
             
             // Draw subtle grid lines
             ctx.strokeStyle = `rgba(79, 195, 247, 0.08)`;
             ctx.lineWidth = 0.5;
             
             // Horizontal grid lines
             for (let i = 1; i <= 2; i++) {
                 const y = padding + (chartHeight / 3) * i;
                 ctx.beginPath();
                 ctx.moveTo(padding, y);
                 ctx.lineTo(width - padding, y);
                 ctx.stroke();
             }
             
             // Draw main price line
             ctx.strokeStyle = trendColor;
             ctx.lineWidth = 2.2;
             ctx.lineCap = 'round';
             ctx.lineJoin = 'round';
             ctx.shadowColor = trendColor;
             ctx.shadowBlur = 3;
             ctx.shadowOffsetY = 0;
             
             ctx.beginPath();
             priceData.forEach((price, index) => {
                 const x = padding + (chartWidth / (dataPoints - 1)) * index;
                 const y = padding + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
                 
                 if (index === 0) {
                     ctx.moveTo(x, y);
                 } else {
                     ctx.lineTo(x, y);
                 }
             });
             ctx.stroke();
             ctx.shadowBlur = 0; // Reset shadow
             
             // Fill area under curve
             ctx.fillStyle = fillGradient;
             ctx.beginPath();
             priceData.forEach((price, index) => {
                 const x = padding + (chartWidth / (dataPoints - 1)) * index;
                 const y = padding + chartHeight - ((price - minPrice) / priceRange) * chartHeight;
                 
                 if (index === 0) {
                     ctx.moveTo(x, y);
                 } else {
                     ctx.lineTo(x, y);
                 }
             });
             ctx.lineTo(width - padding, height - padding);
             ctx.lineTo(padding, height - padding);
             ctx.closePath();
             ctx.fill();
             
             // Draw last price point highlight
             const lastIndex = priceData.length - 1;
             const lastX = padding + (chartWidth / (dataPoints - 1)) * lastIndex;
             const lastY = padding + chartHeight - ((priceData[lastIndex] - minPrice) / priceRange) * chartHeight;
             
             // Outer glow
             ctx.beginPath();
             ctx.arc(lastX, lastY, 4, 0, 2 * Math.PI);
             ctx.fillStyle = `rgba(${trendColorRGB}, 0.3)`;
             ctx.fill();
             
             // Inner point
             ctx.beginPath();
             ctx.arc(lastX, lastY, 2, 0, 2 * Math.PI);
             ctx.fillStyle = trendColor;
             ctx.fill();
             ctx.strokeStyle = '#ffffff';
             ctx.lineWidth = 1;
             ctx.stroke();
             
             // Update trend indicators
             updateTrendIndicators(isUpTrend, trendStrength);
         }
         
         // Trend indicator g√ºncelleme fonksiyonu
         function updateTrendIndicators(isUpTrend, trendStrength) {
             const trendIcon = document.querySelector('.trend-icon');
             const chartIndicator = document.querySelector('.chart-trend-indicator');
             
             if (trendIcon) {
                 trendIcon.className = `fas fa-trending-${isUpTrend ? 'up' : 'down'} trend-icon${isUpTrend ? '' : ' down'}`;
             }
             
             if (chartIndicator) {
                 const intensity = Math.min(trendStrength * 3, 0.4); // Max 0.4 opacity
                 chartIndicator.style.background = isUpTrend 
                     ? `rgba(0, 230, 118, ${0.25 + intensity})` 
                     : `rgba(255, 82, 82, ${0.25 + intensity})`;
             }
         }
         
         // Mini chart kaldƒ±rƒ±ldƒ± - Sadece Chart.js kullanƒ±yoruz
         
         // Chart.js ile animasyonlu grafik olu≈ütur
         let tradingChart = null;
         
         // Sayfa y√ºklendiƒüinde Chart.js'in hazƒ±r olduƒüunu garanti et
         window.addEventListener('load', function() {
            // Chart.js hazƒ±r
         });
         
         function initTradingChart() {
             console.log('üöÄüöÄüöÄ initTradingChart ba≈ülatƒ±ldƒ±!');
             
             // Chart.js y√ºklenmi≈ü mi kontrol et
             if (typeof Chart === 'undefined') {
                 console.error('‚ùå‚ùå‚ùå Chart.js y√ºklenmemi≈ü!');
                 setTimeout(initTradingChart, 1000); // 1 saniye bekle ve tekrar dene
                 return;
             }
             
             console.log('‚úÖ‚úÖ‚úÖ Chart.js y√ºklendi');
             
             const chartContainer = document.querySelector('.chart-container-modern');
             console.log('üì¶ Chart container:', chartContainer);
             
             const ctx = document.getElementById('tradingChart');
             console.log('üìä Canvas element:', ctx);
             
             if (!ctx) {
                 console.error('‚ùå‚ùå‚ùå tradingChart canvas bulunamadƒ±!');
                 return;
             }
             
             console.log('‚úÖ‚úÖ‚úÖ Canvas bulundu!');
             console.log('üìè Canvas dimensions:', ctx.width, 'x', ctx.height);
             console.log('üé® Canvas style:', ctx.style.cssText);
             
             if (!ctx) {
                 console.error('‚ùå tradingChart canvas bulunamadƒ±!');
                 return;
             }
             
             // Eƒüer √∂nceki chart varsa yok et
             if (tradingChart) {
                 tradingChart.destroy();
             }
             
                         // √áok basit test verisi
             const data = [];
             for (let i = 0; i < 20; i++) { // Sadece 20 nokta
                 data.push({
                     x: i,
                     y: 45000 + (i * 100) + (Math.random() * 200 - 100) // Basit artan trend
                 });
             }
             
             // √áok basit chart konfig√ºrasyonu
             const config = {
                 type: 'line',
                 data: {
                     labels: data.map((_, index) => index),
                     datasets: [{
                         label: 'Test',
                         data: data.map(d => d.y),
                         borderColor: '#ff0000',
                         backgroundColor: 'rgba(255, 0, 0, 0.5)',
                         borderWidth: 5,
                         fill: false,
                         tension: 0,
                         pointRadius: 5,
                         pointBackgroundColor: '#ff0000',
                         pointBorderColor: '#ffffff',
                         pointBorderWidth: 2,
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             display: true
                         }
                     },
                     scales: {
                         x: {
                             type: 'linear',
                             display: true,
                             grid: {
                                 color: '#ffffff',
                                 drawBorder: true,
                             },
                             ticks: {
                                 color: '#ffffff',
                                 font: {
                                     size: 14
                                 }
                             }
                         },
                         y: {
                             display: true,
                             grid: {
                                 color: '#ffffff',
                                 drawBorder: true,
                             },
                             ticks: {
                                 color: '#ffffff',
                                 font: {
                                     size: 14
                                 }
                             }
                         }
                     },
                     animation: {
                         duration: 0 // Kendi animasyonumuzu kullanacaƒüƒ±z
                     },
                     interaction: {
                         intersect: false,
                         mode: 'index'
                     }
                 }
             };
             
             // Chart'ƒ± olu≈ütur
                          try {
                 console.log('üé®üé®üé® Chart olu≈üturuluyor...');
                 console.log('üìä Data length:', data.length);
                 console.log('üìä Sample data:', data.slice(0, 5));
                 console.log('‚öôÔ∏è Config type:', config.type);
                 
                 tradingChart = new Chart(ctx, config);
                 console.log('‚úÖ‚úÖ‚úÖ Chart ba≈üarƒ±yla olu≈üturuldu');
                 
                 tradingChart.update();
                 console.log('‚úÖ‚úÖ‚úÖ Chart render edildi');
                 
                 // Chart'ƒ±n ger√ßekten render edilip edilmediƒüini kontrol et
                 setTimeout(() => {
                     console.log('üîç Chart render kontrol√º...');
                     console.log('üìä Chart data:', tradingChart.data);
                     console.log('üìè Chart canvas size:', tradingChart.canvas.width, 'x', tradingChart.canvas.height);
                 }, 1000);
                 
             } catch (error) {
                 console.error('‚ùå‚ùå‚ùå Chart olu≈üturulurken hata:', error);
                 console.error('‚ùå‚ùå‚ùå Error stack:', error.stack);
             }
         }
         
         // Modal kapanƒ±rken chart'ƒ± temizle
         function destroyTradingChart() {
             if (tradingChart) {
                 tradingChart.destroy();
                 tradingChart = null;
             }
         }
         
         // Coin bulunamadƒ± mesajƒ±
         function showNoCoinsMessage(searchInput) {
             const marketLoader = document.getElementById('marketLoader');
             marketLoader.innerHTML = `
                 <div style="text-align: center; color: #8896ab; padding: 40px;">
                     <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                     <h3 style="color: #ffffff; margin-bottom: 12px;">
                         ${searchInput ? 'Coin Bulunamadƒ±' : 'Coin Listesi Bo≈ü'}
                     </h3>
                     <p style="margin-bottom: 20px;">
                         ${searchInput ? 'Aradƒ±ƒüƒ±nƒ±z kripto para bulunamadƒ±' : 'Veritabanƒ±nda coin bulunamadƒ±'}
                     </p>
                     <button onclick="fetchMarketData()" style="background: #4fc3f7; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                         <i class="fas fa-sync-alt"></i> Yenile
                     </button>
                 </div>
             `;
         }
         
         // Hata mesajƒ±
         function showErrorMessage() {
             const marketLoader = document.getElementById('marketLoader');
             if (marketLoader) {
                 marketLoader.style.display = 'flex';
                 marketLoader.innerHTML = `
                     <div style="text-align: center; color: #f44336; padding: 40px;">
                         <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                         <h3 style="color: #ffffff; margin-bottom: 12px;">Baƒülantƒ± Hatasƒ±</h3>
                         <p style="color: #8896ab; margin-bottom: 20px;">Piyasa verileri y√ºklenirken hata olu≈ütu. API baƒülantƒ±sƒ±nƒ± kontrol edin.</p>
                         <button onclick="refreshMarketData()" style="background: #4fc3f7; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                             <i class="fas fa-redo"></i> Tekrar Dene
                         </button>
                         <button onclick="showMockMarketData()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                             <i class="fas fa-eye"></i> Demo Veriler
                         </button>
                     </div>
                 `;
             }
             
             // Kullanƒ±cƒ±ya bildirim g√∂ster
             if (typeof showNotification === 'function') {
                 showNotification('Piyasa verileri y√ºklenemedi. Demo veriler g√∂steriliyor.', 'error');
             }
         }
         
         // Mock piyasa verileri g√∂ster
         function showMockMarketData() {
             const mockCoins = [
                 {
                     id: 1,
                     coin_adi: 'Bitcoin',
                     coin_kodu: 'BTC',
                     current_price: 96480.50,
                     price_change_24h: 2.35,
                     market_cap: 1900000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png'
                 },
                 {
                     id: 2,
                     coin_adi: 'Ethereum',
                     coin_kodu: 'ETH',
                     current_price: 3420.75,
                     price_change_24h: -1.22,
                     market_cap: 410000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/279/large/ethereum.png'
                 },
                 {
                     id: 3,
                     coin_adi: 'BNB',
                     coin_kodu: 'BNB',
                     current_price: 685.20,
                     price_change_24h: 0.88,
                     market_cap: 99000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png'
                 },
                 {
                     id: 4,
                     coin_adi: 'Solana',
                     coin_kodu: 'SOL',
                     current_price: 238.45,
                     price_change_24h: 4.65,
                     market_cap: 113000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/4128/large/solana.png'
                 },
                 {
                     id: 5,
                     coin_adi: 'XRP',
                     coin_kodu: 'XRP',
                     current_price: 2.35,
                     price_change_24h: 12.88,
                     market_cap: 133000000000,
                     logo_url: 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png'
                 }
             ];
             
             renderModernCoins(mockCoins);
             document.getElementById('marketLoader').style.display = 'none';
             
             // Ba≈üarƒ± mesajƒ± g√∂ster
             if (typeof showNotification === 'function') {
                 showNotification('Demo piyasa verileri y√ºklendi.', 'success');
             }
         }

        // Enhanced Trading Modal - coins.php ile √ßalƒ±≈üƒ±r
        function openTradingModal(coinId, coinName, currentPrice, direction = 'buy', coinSymbol = '') {
            console.log('üöÄ ENHANCED TRADING MODAL A√áILIYOR!', { coinId, coinName, currentPrice, direction, coinSymbol });
            const modal = document.getElementById('tradingModal');
            
            // Global deƒüi≈ükenlere kaydet
            window.currentTradingCoin = {
                id: coinId,
                name: coinName,
                price: parseFloat(currentPrice),
                symbol: coinSymbol || coinName.substring(0, 3).toUpperCase(),
                direction: direction
            };
            
            // Fiyat zaten TL cinsinden (backend'den geliyor)
            const priceInTL = parseFloat(currentPrice);
            window.currentTradingCoin.priceInTL = priceInTL;
            
            // Modal'ƒ± g√∂ster
            modal.style.display = 'flex';
            
            // Coin bilgilerini modal'a y√ºkle
            const symbol = coinSymbol || coinName.substring(0, 3).toUpperCase();
            document.getElementById('modalCoinName').textContent = coinName;
            document.getElementById('modalCoinSymbol').textContent = symbol;
            document.getElementById('modalCoinPrice').textContent = `‚Ç∫${priceInTL.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // D√úZELTME: Modal coin icon'unu dinamik olarak ayarla
            updateModalCoinIcon(symbol);
            
            // Price change g√∂ster
            const changeElement = document.getElementById('modalCoinChange');
            const change = (Math.random() - 0.5) * 10; // Random deƒüi≈üim %
            changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
            changeElement.className = `price-change ${change >= 0 ? 'positive' : 'negative'}`;
            
            // Al/Sat fiyatlarƒ±nƒ± g√ºncelle (0.1% spread)
            const buyPrice = priceInTL * 1.001;
            const sellPrice = priceInTL * 0.999;
            document.getElementById('buyPrice').textContent = `‚Ç∫${buyPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('sellPrice').textContent = `‚Ç∫${sellPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Summary'de coin fiyatƒ±nƒ± g√∂ster
            document.getElementById('currentCoinPrice').textContent = `‚Ç∫${priceInTL.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Quantity suffix'i g√ºncelle
            document.getElementById('quantitySuffix').textContent = symbol;
            
            // Global deƒüi≈ükenleri g√ºncelle
            currentCoinPrice = priceInTL;
            currentCoinSymbol = symbol;
            
            // Direction'a g√∂re initial state ayarla
            setTradingDirection(direction);
            
            // Kullanƒ±cƒ±nƒ±n mevcut bakiyesini y√ºkle
            loadUserBalance();
            
            // Form'u sƒ±fƒ±rla
            resetTradingForm();
            
            // Event listener'larƒ± setup et
            setupEnhancedTradingModalEvents();
        }
        
        // Trading direction ayarla
        function setTradingDirection(direction) {
            const buyBtn = document.querySelector('.direction-btn.buy-btn');
            const sellBtn = document.querySelector('.direction-btn.sell-btn');
            const executeBtn = document.getElementById('executeOrderBtn');
            const executeText = document.getElementById('executeText');
            
            if (currentLeverageMode === 'leverage') {
                // Kaldƒ±ra√ßlƒ± i≈ülemde pozisyon tipine g√∂re buton metni
                const positionText = currentPositionType === 'long' ? 'Long Pozisyon A√ß' : 'Short Pozisyon A√ß';
                executeBtn.className = `execute-btn ${currentPositionType === 'long' ? 'buy-order' : 'sell-order'}`;
                executeText.textContent = `${window.currentTradingCoin.symbol} ${positionText}`;
                
                // Direction butonlarƒ±nƒ± gizle (kaldƒ±ra√ßta pozisyon tipi kullanƒ±lƒ±r)
                buyBtn.style.display = 'none';
                sellBtn.style.display = 'none';
            } else {
                // Spot i≈ülemde normal buy/sell
                buyBtn.style.display = 'flex';
                sellBtn.style.display = 'flex';
                
                if (direction === 'buy') {
                    buyBtn.classList.add('active');
                    sellBtn.classList.remove('active');
                    executeBtn.className = 'execute-btn buy-order';
                    executeText.textContent = `${window.currentTradingCoin.symbol} Satƒ±n Al`;
                } else {
                    sellBtn.classList.add('active');
                    buyBtn.classList.remove('active');
                    executeBtn.className = 'execute-btn sell-order';
                    executeText.textContent = `${window.currentTradingCoin.symbol} Sat`;
                }
            }
            
            window.currentTradingCoin.direction = direction;
            calculateTrade();
            updateTradingCalculations();
        }
        
        // Kullanƒ±cƒ± bakiyesini y√ºkle
        async function loadUserBalance() {
            try {
                const response = await fetch('backend/public/profile.php', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                if (result.success && result.user) {
                    window.currentUserBalance = parseFloat(result.user.balance) || 0;
                    document.getElementById('currentBalance').textContent = `‚Ç∫${window.currentUserBalance.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
                } else {
                    window.currentUserBalance = 0;
                    document.getElementById('currentBalance').textContent = '‚Ç∫0.00';
                }
            } catch (error) {
                console.error('Balance loading error:', error);
                window.currentUserBalance = 0;
                document.getElementById('currentBalance').textContent = '‚Ç∫0.00';
            }
        }
        
        // Trading form'u sƒ±fƒ±rla
        function resetTradingForm() {
            document.getElementById('coinAmount').value = '';
            document.getElementById('totalAmount').value = '';
            
            // Input tabs - default olarak miktar sekmesi aktif
            document.querySelector('.input-tab[data-tab="amount"]').classList.add('active');
            document.querySelector('.input-tab[data-tab="total"]').classList.remove('active');
            document.getElementById('amountSection').style.display = 'block';
            document.getElementById('totalSection').style.display = 'none';
            
            // Percentage butonlarƒ±nƒ± sƒ±fƒ±rla
            document.querySelectorAll('.percent-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Summary'yi sƒ±fƒ±rla
            resetSummary();
            
            // Execute butonunu deaktif et
            document.getElementById('executeOrderBtn').disabled = true;
            
            // Balance warning'i gizle
            document.getElementById('balanceWarning').style.display = 'none';
        }
        
        // Summary'yi sƒ±fƒ±rla
        function resetSummary() {
            document.getElementById('calculatedAmount').textContent = `0.00000000 ${window.currentTradingCoin.symbol}`;
            document.getElementById('calculatedTotal').textContent = '‚Ç∫0.00';
            document.getElementById('calculatedFee').textContent = '‚Ç∫0.00';
            document.getElementById('finalTotal').textContent = '‚Ç∫0.00';
            document.getElementById('remainingBalance').textContent = `‚Ç∫${(window.currentUserBalance || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('executeOrderBtn').disabled = true;
        }
        
        // Enhanced modal event listener'larƒ±
        function setupEnhancedTradingModalEvents() {
            // Direction butonlarƒ±
            document.querySelectorAll('.direction-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const direction = this.dataset.direction;
                    setTradingDirection(direction);
                });
            });
            
            // Input tabs
            document.querySelectorAll('.input-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.dataset.tab;
                    
                    // Tab'larƒ± g√ºncelle
                    document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // B√∂l√ºmleri g√∂ster/gizle
                    if (tabType === 'amount') {
                        document.getElementById('amountSection').style.display = 'block';
                        document.getElementById('totalSection').style.display = 'none';
                    } else {
                        document.getElementById('amountSection').style.display = 'none';
                        document.getElementById('totalSection').style.display = 'block';
                    }
                    
                    calculateTrade();
                });
            });
            
            // Input field'lar i√ßin hesaplama
            document.getElementById('coinAmount').addEventListener('input', function() {
                calculateTrade();
                updateTradingCalculations();
            });
            
            document.getElementById('totalAmount').addEventListener('input', function() {
                calculateTradeFromTotal();
                updateTradingCalculations();
            });
            
            // Percentage butonlarƒ±
            document.querySelectorAll('.percent-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const percent = parseInt(this.dataset.percent);
                    
                    // Aktif percentage butonunu g√ºncelle
                    document.querySelectorAll('.percent-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    applyPercentage(percent);
                });
            });
            
            // Execute butonu
            document.getElementById('executeOrderBtn').addEventListener('click', executeEnhancedOrder);
        }
        
        // Miktar bazlƒ± hesaplama
        function calculateTrade() {
            const coinAmount = parseFloat(document.getElementById('coinAmount').value) || 0;
            const coinPrice = window.currentTradingCoin.priceInTL;
            const direction = window.currentTradingCoin.direction;
            
            if (coinAmount <= 0) {
                resetSummary();
                return;
            }
            
            // ƒ∞≈ülem tutarƒ±nƒ± hesapla
            const tradeTotal = coinAmount * coinPrice;
            const fee = tradeTotal * 0.001; // 0.1% komisyon
            const finalTotal = tradeTotal + fee;
            
            // Summary'yi g√ºncelle
            document.getElementById('calculatedAmount').textContent = `${coinAmount.toFixed(8)} ${window.currentTradingCoin.symbol}`;
            document.getElementById('calculatedTotal').textContent = `‚Ç∫${tradeTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('calculatedFee').textContent = `‚Ç∫${fee.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('finalTotal').textContent = `‚Ç∫${finalTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Kalan bakiye hesapla
            const currentBalance = window.currentUserBalance || 0;
            let remainingBalance = currentBalance;
            
            if (direction === 'buy') {
                remainingBalance = currentBalance - finalTotal;
            } else {
                remainingBalance = currentBalance + tradeTotal - fee;
            }
            
            document.getElementById('remainingBalance').textContent = `‚Ç∫${remainingBalance.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Execute butonunu aktif/deaktif et ve balance warning g√∂ster
            const executeBtn = document.getElementById('executeOrderBtn');
            const balanceWarning = document.getElementById('balanceWarning');
            
            if (direction === 'buy') {
                if (finalTotal > currentBalance) {
                    executeBtn.disabled = true;
                    balanceWarning.style.display = 'flex';
                } else {
                    executeBtn.disabled = coinAmount <= 0;
                    balanceWarning.style.display = 'none';
                }
            } else {
                executeBtn.disabled = coinAmount <= 0;
                balanceWarning.style.display = 'none';
            }
        }
        
        // Toplam tutar bazlƒ± hesaplama
        function calculateTradeFromTotal() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const coinPrice = window.currentTradingCoin.priceInTL;
            const direction = window.currentTradingCoin.direction;
            
            if (totalAmount <= 0) {
                resetSummary();
                return;
            }
            
            // Komisyon dahil toplam tutardan net tutarƒ± hesapla
            const fee = totalAmount * 0.001; // 0.1% komisyon
            const netAmount = totalAmount - fee;
            const coinAmount = netAmount / coinPrice;
            
            // Summary'yi g√ºncelle
            document.getElementById('calculatedAmount').textContent = `${coinAmount.toFixed(8)} ${window.currentTradingCoin.symbol}`;
            document.getElementById('calculatedTotal').textContent = `‚Ç∫${netAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('calculatedFee').textContent = `‚Ç∫${fee.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            document.getElementById('finalTotal').textContent = `‚Ç∫${totalAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Coin amount input'u g√ºncelle
            document.getElementById('coinAmount').value = coinAmount.toFixed(8);
            
            // Kalan bakiye hesapla
            const currentBalance = window.currentUserBalance || 0;
            let remainingBalance = currentBalance;
            
            if (direction === 'buy') {
                remainingBalance = currentBalance - totalAmount;
            } else {
                remainingBalance = currentBalance + netAmount;
            }
            
            document.getElementById('remainingBalance').textContent = `‚Ç∫${remainingBalance.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`;
            
            // Execute butonunu aktif/deaktif et ve balance warning g√∂ster
            const executeBtn = document.getElementById('executeOrderBtn');
            const balanceWarning = document.getElementById('balanceWarning');
            
            if (direction === 'buy') {
                if (totalAmount > currentBalance) {
                    executeBtn.disabled = true;
                    balanceWarning.style.display = 'flex';
                } else {
                    executeBtn.disabled = coinAmount <= 0;
                    balanceWarning.style.display = 'none';
                }
            } else {
                executeBtn.disabled = coinAmount <= 0;
                balanceWarning.style.display = 'none';
            }
        }
        
        // Y√ºzdelik hesaplama uygula
        function applyPercentage(percent) {
            const currentBalance = window.currentUserBalance || 0;
            const direction = window.currentTradingCoin.direction;
            
            // Hangi tab aktif olduƒüunu kontrol et
            const activeTab = document.querySelector('.input-tab.active');
            const currentTabType = activeTab ? activeTab.dataset.tab : 'amount';
            
            if (direction === 'buy') {
                // Satƒ±n alma i√ßin
                if (currentTabType === 'total') {
                    // Toplam ‚Ç∫ tab'ƒ±ndaysa - bakiyenin %'ini harcanacak tutar olarak ayarla
                    const targetAmount = (currentBalance * percent) / 100;
                    document.getElementById('totalAmount').value = targetAmount.toFixed(2);
                    calculateTradeFromTotal();
                } else {
                    // Miktar tab'ƒ±ndaysa - √∂nce toplam ‚Ç∫'yi hesapla, sonra miktar tab'ƒ±nda g√∂ster
                    const targetTotalAmount = (currentBalance * percent) / 100;
                    const coinPrice = window.currentTradingCoin.priceInTL;
                    const coinAmount = targetTotalAmount / coinPrice;
                    document.getElementById('coinAmount').value = coinAmount.toFixed(8);
                    calculateTrade();
                }
            } else {
                // Satƒ±≈ü i√ßin - portf√∂ydeki coin'in %'ini sat
                const coinPrice = window.currentTradingCoin.priceInTL;
                
                if (currentTabType === 'amount') {
                    // Miktar tab'ƒ±ndaysa
                    const targetAmount = (currentBalance * percent) / (100 * coinPrice);
                    document.getElementById('coinAmount').value = targetAmount.toFixed(8);
                    calculateTrade();
                } else {
                    // Toplam ‚Ç∫ tab'ƒ±ndaysa
                    const targetTotalAmount = (currentBalance * percent) / 100;
                    document.getElementById('totalAmount').value = targetTotalAmount.toFixed(2);
                    calculateTradeFromTotal();
                }
            }
        }
        
        // Enhanced order execution
        async function executeEnhancedOrder() {
            console.log('üéØ Execute button tƒ±klandƒ±!');
            console.log('üîç Mevcut mod:', currentLeverageMode);
            
            if (!window.currentTradingCoin) {
                console.error('‚ùå currentTradingCoin bulunamadƒ±');
                showNotification('Coin bilgisi bulunamadƒ±', 'error');
                return;
            }
            
            // Kaldƒ±ra√ßlƒ± i≈ülem kontrol√º
            if (currentLeverageMode === 'leverage') {
                console.log('üîÑ Kaldƒ±ra√ßlƒ± i≈ülem ba≈ülatƒ±lƒ±yor...', {
                    mode: currentLeverageMode,
                    leverage: currentLeverage,
                    positionType: currentPositionType,
                    coinSymbol: window.currentTradingCoin?.symbol,
                    price: window.currentTradingCoin?.priceInTL
                });
                
                // Miktar hesapla
                const coinAmount = parseFloat(document.getElementById('coinAmount').value) || 0;
                const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
                let investedAmount = 0;
                
                if (totalAmount > 0) {
                    investedAmount = totalAmount;
                } else if (coinAmount > 0) {
                    investedAmount = (coinAmount * window.currentTradingCoin.priceInTL) / currentLeverage;
                } else {
                    showNotification('L√ºtfen bir miktar giriniz', 'error');
                    return;
                }
                
                console.log('üí∞ Yatƒ±rƒ±m miktarƒ± hesaplandƒ±:', investedAmount);
                
                await executeLeverageOrder({
                    coin_symbol: window.currentTradingCoin.symbol,
                    invested_amount: investedAmount,
                    entry_price: window.currentTradingCoin.priceInTL
                });
                return;
            }
            
            const direction = window.currentTradingCoin.direction;
            const coinAmount = parseFloat(document.getElementById('coinAmount').value);
            const currentPrice = window.currentTradingCoin.priceInTL;
            
            if (!coinAmount || coinAmount <= 0) {
                showNotification('Ge√ßerli bir miktar giriniz', 'error');
                return;
            }
            
            // Bakiye kontrol√º
            const tradeTotal = coinAmount * currentPrice;
            const fee = tradeTotal * 0.001;
            const finalTotal = tradeTotal + fee;
            
            if (direction === 'buy' && finalTotal > (window.currentUserBalance || 0)) {
                showNotification('Yetersiz bakiye', 'error');
                return;
            }
            
            // Loading state
            const executeBtn = document.getElementById('executeOrderBtn');
            const executeText = document.getElementById('executeText');
            const originalText = executeText.textContent;
            
            executeBtn.disabled = true;
            executeText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒ∞≈üleniyor...';
            
            try {
                const formData = new FormData();
                formData.append('coin_id', window.currentTradingCoin.id);
                formData.append('miktar', coinAmount);
                formData.append('fiyat', currentPrice);
                
                const response = await fetch(`backend/user/trading.php?action=${direction}`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                console.log('üîÑ Enhanced Trading result:', result);
                
                if (result.success) {
                    const directionText = direction === 'buy' ? 'SATIN ALMA' : 'SATIM';
                    const totalAmount = result.data.toplam_tutar;
                    
                    // Ba≈üarƒ± bildirimi
                    showNotification(
                        `‚úÖ ${directionText} ƒ∞≈ülemi Ba≈üarƒ±lƒ±!\n${coinAmount.toFixed(8)} ${window.currentTradingCoin.symbol} - ‚Ç∫${totalAmount.toLocaleString('tr-TR')}`,
                        'success'
                    );
                    
                    // Modal'ƒ± kapat
                    closeTradingModal();
                    
                    // Kullanƒ±cƒ± bilgilerini ve portf√∂y√º g√ºncelle
                    setTimeout(() => {
                        loadUserInfo();
                        if (typeof loadPortfolio === 'function') {
                            loadPortfolio();
                        }
                    }, 500);
                    
                } else {
                    showNotification(`‚ùå ƒ∞≈ülem Hatasƒ±: ${result.message}`, 'error');
                    executeBtn.disabled = false;
                    executeText.textContent = originalText;
                }
                
            } catch (error) {
                console.error('Enhanced Trading API Error:', error);
                showNotification('‚ùå Baƒülantƒ± hatasƒ±. L√ºtfen tekrar deneyin.', 'error');
                executeBtn.disabled = false;
                executeText.textContent = originalText;
            }
        }

        // Modal coin icon'unu dinamik olarak g√ºncelle - D√úZELTME: String parsing ve hizalama sorunlarƒ±
        function updateModalCoinIcon(coinSymbol) {
            const modalCoinIconContainer = document.querySelector('.coin-icon-container');
            if (!modalCoinIconContainer) return;
            
            // G√ºvenli string i≈üleme i√ßin coinSymbol'√º temizle
            const safeCoinSymbol = String(coinSymbol).trim().toUpperCase();
            
            // Ger√ßek coin logolarƒ± (piyasalardaki gibi)
            const coinLogos = {
                'BTC': 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png',
                'ETH': 'https://assets.coingecko.com/coins/images/279/large/ethereum.png',
                'BNB': 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png',
                'ADA': 'https://assets.coingecko.com/coins/images/975/large/cardano.png',
                'SOL': 'https://assets.coingecko.com/coins/images/4128/large/solana.png',
                'XRP': 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png',
                'DOT': 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png',
                'DOGE': 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png',
                'AVAX': 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png',
                'SHIB': 'https://assets.coingecko.com/coins/images/11939/large/shiba.png',
                'LINK': 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png',
                'TRX': 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png',
                'MATIC': 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png',
                'LTC': 'https://assets.coingecko.com/coins/images/2/large/litecoin.png',
                'BCH': 'https://assets.coingecko.com/coins/images/780/large/bitcoin-cash-circle.png',
                'UNI': 'https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png',
                'ATOM': 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png',
                'XLM': 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png',
                'VET': 'https://assets.coingecko.com/coins/images/1167/large/VeChain-Logo-768x725.png',
                'FIL': 'https://assets.coingecko.com/coins/images/12817/large/filecoin.png',
                'THETA': 'https://assets.coingecko.com/coins/images/2538/large/theta-token-logo.png',
                'ICP': 'https://assets.coingecko.com/coins/images/14495/large/Internet_Computer_logo.png',
                'ALGO': 'https://assets.coingecko.com/coins/images/4380/large/download.png',
                'XTZ': 'https://assets.coingecko.com/coins/images/976/large/Tezos-logo.png',
                'EGLD': 'https://assets.coingecko.com/coins/images/12335/large/egld-token-logo.png',
                'AAVE': 'https://assets.coingecko.com/coins/images/12645/large/AAVE.png',
                'EOS': 'https://assets.coingecko.com/coins/images/738/large/eos-eos-logo.png',
                'XMR': 'https://assets.coingecko.com/coins/images/69/large/monero_logo.png',
                'MANA': 'https://assets.coingecko.com/coins/images/878/large/decentraland-mana.png',
                'SAND': 'https://assets.coingecko.com/coins/images/12129/large/sandbox_logo.jpg',
                'CRO': 'https://assets.coingecko.com/coins/images/7310/large/cypto.png',
                'NEAR': 'https://assets.coingecko.com/coins/images/10365/large/near_icon.png',
                'APE': 'https://assets.coingecko.com/coins/images/24383/large/apecoin.jpg',
                'LDO': 'https://assets.coingecko.com/coins/images/13573/large/Lido_DAO.png',
                'USDT': 'https://assets.coingecko.com/coins/images/325/large/Tether.png',
                'USDC': 'https://assets.coingecko.com/coins/images/6319/large/USD_Coin_icon.png',
                'BUSD': 'https://assets.coingecko.com/coins/images/9576/large/BUSD.png',
                'DAI': 'https://assets.coingecko.com/coins/images/9956/large/4943.png'
            };
            
            // Logo URL'ini belirle
            const logoUrl = coinLogos[safeCoinSymbol];
            const firstLetter = safeCoinSymbol.charAt(0) || 'C';
            
            // Container'ƒ± temizle
            modalCoinIconContainer.innerHTML = '';
            
            if (logoUrl) {
                // Logo ile container olu≈ütur - D√úZELTME: Hizalama ve fallback
                const logoImg = document.createElement('img');
                logoImg.src = logoUrl;
                logoImg.alt = safeCoinSymbol;
                logoImg.style.cssText = `
                    width: 100%;
                    height: 100%;
                    border-radius: 50%;
                    object-fit: cover;
                    object-position: center;
                    display: block;
                    margin: 0;
                    padding: 0;
                `;
                
                // Hata durumunda fallback
                logoImg.onerror = function() {
                    console.warn(`Logo y√ºklenemedi: ${logoUrl}`);
                    modalCoinIconContainer.innerHTML = `
                        <div style="
                            width: 100%;
                            height: 100%;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #ff7c4c 0%, #ff9a3c 100%);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 24px;
                            color: white;
                            font-weight: bold;
                            margin: 0;
                            padding: 0;
                        ">${firstLetter}</div>
                    `;
                };
                
                modalCoinIconContainer.appendChild(logoImg);
                
            } else {
                // Logo yoksa sadece harf g√∂ster - D√úZELTME: Merkezi hizalama
                modalCoinIconContainer.innerHTML = `
                    <div style="
                        width: 100%;
                        height: 100%;
                        border-radius: 50%;
                        background: linear-gradient(135deg, #ff7c4c 0%, #ff9a3c 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                        color: white;
                        font-weight: bold;
                        margin: 0;
                        padding: 0;
                    ">${firstLetter}</div>
                `;
            }
            
            console.log(`üé® Modal logo g√ºncellendi: ${safeCoinSymbol} -> ${logoUrl || 'Letter: ' + firstLetter}`);
        }

        // Enhanced Trading modalƒ±nƒ± kapat
        function closeTradingModal() {
            const modal = document.getElementById('tradingModal');
            if (!modal) return;
            
            const container = modal.querySelector('.modal-container-enhanced');
            
            // Animasyon ile kapat
            if (container) {
                container.style.transform = 'scale(0.9) translateY(20px)';
                container.style.opacity = '0';
            }
            
            // Modal overlay'i de gizle
            const overlay = modal.querySelector('.modal-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
            }
            
            setTimeout(() => {
                modal.style.display = 'none';
                
                // Container'ƒ± sƒ±fƒ±rla
                if (container) {
                    container.style.transform = '';
                    container.style.opacity = '';
                }
                
                // Overlay'i sƒ±fƒ±rla
                if (overlay) {
                    overlay.style.opacity = '';
                }
                
                // Global deƒüi≈ükenleri temizle
                window.currentTradingCoin = null;
                window.currentUserBalance = null;
                currentCoinPrice = 0;
                currentCoinSymbol = '';
                
                // Form'u tamamen sƒ±fƒ±rla
                resetTradingFormCompletely();
                
                // Event listener'larƒ± temizle
                cleanupModalEventListeners();
                
            }, 300);
        }
        
        // Trading form'u tamamen sƒ±fƒ±rla
        function resetTradingFormCompletely() {
            // Input alanlarƒ±nƒ± temizle
            const coinAmountInput = document.getElementById('coinAmount');
            const totalAmountInput = document.getElementById('totalAmount');
            
            if (coinAmountInput) coinAmountInput.value = '';
            if (totalAmountInput) totalAmountInput.value = '';
            
            // Tab'larƒ± sƒ±fƒ±rla
            const amountTab = document.querySelector('.input-tab[data-tab="amount"]');
            const totalTab = document.querySelector('.input-tab[data-tab="total"]');
            
            if (amountTab) amountTab.classList.add('active');
            if (totalTab) totalTab.classList.remove('active');
            
            // Section'larƒ± sƒ±fƒ±rla
            const amountSection = document.getElementById('amountSection');
            const totalSection = document.getElementById('totalSection');
            
            if (amountSection) amountSection.style.display = 'block';
            if (totalSection) totalSection.style.display = 'none';
            
            // Percentage butonlarƒ±nƒ± sƒ±fƒ±rla
            document.querySelectorAll('.percent-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Direction butonlarƒ±nƒ± sƒ±fƒ±rla
            const buyBtn = document.querySelector('.direction-btn.buy-btn');
            const sellBtn = document.querySelector('.direction-btn.sell-btn');
            
            if (buyBtn) buyBtn.classList.add('active');
            if (sellBtn) sellBtn.classList.remove('active');
            
            // Execute butonunu deaktif et
            const executeBtn = document.getElementById('executeOrderBtn');
            if (executeBtn) {
                executeBtn.disabled = true;
                executeBtn.className = 'execute-btn buy-order';
            }
            
            // Balance warning'i gizle
            const balanceWarning = document.getElementById('balanceWarning');
            if (balanceWarning) {
                balanceWarning.style.display = 'none';
            }
            
            // Kaldƒ±ra√ß ayarlarƒ±nƒ± sƒ±fƒ±rla
            currentLeverageMode = 'spot';
            currentLeverage = 1;
            currentPositionType = 'long';
            
            // Mode tab'larƒ±nƒ± sƒ±fƒ±rla
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.mode === 'spot') {
                    tab.classList.add('active');
                }
            });
            
            // Leverage selection'ƒ± gizle
            const leverageSelection = document.getElementById('leverageSelection');
            if (leverageSelection) {
                leverageSelection.style.display = 'none';
            }
            
            // Summary'yi sƒ±fƒ±rla
            resetSummaryCompletely();
        }
        
        // Summary'yi tamamen sƒ±fƒ±rla
        function resetSummaryCompletely() {
            const elements = [
                'calculatedAmount',
                'calculatedTotal', 
                'calculatedFee',
                'finalTotal',
                'currentBalance',
                'remainingBalance',
                'currentCoinPrice'
            ];
            
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (id === 'calculatedAmount') {
                        element.textContent = '0.00000000 BTC';
                    } else if (id === 'currentCoinPrice') {
                        element.textContent = '‚Ç∫0.00';
                    } else {
                        element.textContent = '‚Ç∫0.00';
                    }
                }
            });
        }
        
        // Modal event listener'larƒ± temizle
        function cleanupModalEventListeners() {
            // Yeni event listener'lar eklemeden √∂nce eskilerini temizle
            const modal = document.getElementById('tradingModal');
            if (!modal) return;
            
            // Clone node to remove all event listeners
            const newModal = modal.cloneNode(true);
            modal.parentNode.replaceChild(newModal, modal);
        }

         // Trading modal event listener'larƒ±
         function setupTradingModalEvents() {
             // Direction toggle
             document.querySelectorAll('.direction-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     document.querySelectorAll('.direction-btn').forEach(b => b.classList.remove('active'));
                     this.classList.add('active');
                     
                     const direction = this.dataset.direction;
                     const executeBtn = document.getElementById('executeOrderBtn');
                     const executeText = document.getElementById('executeText');
                     const coinSymbol = document.getElementById('modalCoinSymbol').textContent;
                     
                     if (direction === 'buy') {
                         executeBtn.className = 'execute-btn buy-order';
                         executeText.textContent = `${coinSymbol} Al`;
                     } else {
                         executeBtn.className = 'execute-btn sell-order';
                         executeText.textContent = `${coinSymbol} Sat`;
                     }
                 });
             });

             // Order type deƒüi≈üikliƒüi
             document.getElementById('orderType').addEventListener('change', function() {
                 const priceGroup = document.getElementById('priceGroup');
                 if (this.value === 'limit' || this.value === 'stop_limit') {
                     priceGroup.style.display = 'block';
                 } else {
                     priceGroup.style.display = 'none';
                 }
             });

             // Amount tabs
             document.querySelectorAll('.amount-tab').forEach(tab => {
                 tab.addEventListener('click', function() {
                     document.querySelectorAll('.amount-tab').forEach(t => t.classList.remove('active'));
                     this.classList.add('active');
                     
                     const type = this.dataset.type;
                     const quantityGroup = document.getElementById('quantityGroup');
                     const totalGroup = document.getElementById('totalGroup');
                     
                     if (type === 'quantity') {
                         quantityGroup.style.display = 'block';
                         totalGroup.style.display = 'none';
                     } else {
                         quantityGroup.style.display = 'none';
                         totalGroup.style.display = 'block';
                     }
                 });
             });

             // Percentage buttons
             document.querySelectorAll('.percent-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     const percent = parseInt(this.dataset.percent);
                     const balance = 10000; // User balance (ger√ßek deƒüer backend'den gelecek)
                     const price = parseFloat(document.getElementById('modalCoinPrice').textContent.replace('‚Ç∫', '').replace(',', ''));
                     
                     const totalAmount = (balance * percent) / 100;
                     const quantity = totalAmount / price;
                     
                     document.getElementById('orderQuantity').value = quantity.toFixed(6);
                     updateOrderSummary();
                 });
             });

             // Input deƒüi≈üiklikleri
             ['orderQuantity', 'orderTotal', 'orderPrice'].forEach(id => {
                 const element = document.getElementById(id);
                 if (element) {
                     element.addEventListener('input', updateOrderSummary);
                 }
             });

             // Timeframe buttons
             document.querySelectorAll('.timeframe-btn').forEach(btn => {
                 btn.addEventListener('click', function() {
                     document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                     this.classList.add('active');
                     
                     // Grafik timeframe'ini deƒüi≈ütir
                     const timeframe = this.dataset.timeframe;
                     updateChartTimeframe(timeframe);
                 });
             });

             // Execute order - bu event listener kaldƒ±rƒ±ldƒ± (√ßakƒ±≈üma √∂nlenmesi i√ßin)
         }

         // Order √∂zeti g√ºncelle
         function updateOrderSummary() {
             const quantity = parseFloat(document.getElementById('orderQuantity').value) || 0;
             const price = parseFloat(document.getElementById('modalCoinPrice').textContent.replace('‚Ç∫', '').replace(',', '')) || 0;
             const orderPrice = parseFloat(document.getElementById('orderPrice').value) || price;
             
             const total = quantity * orderPrice;
             const fee = total * 0.001; // 0.1% fee
             const totalWithFee = total + fee;
             
             document.getElementById('orderTotalValue').textContent = `‚Ç∫${total.toFixed(2)}`;
             document.getElementById('tradingFee').textContent = `‚Ç∫${fee.toFixed(2)}`;
             
             // Execute button'ƒ± etkinle≈ütir/devre dƒ±≈üƒ± bƒ±rak
             const executeBtn = document.getElementById('executeOrderBtn');
             executeBtn.disabled = quantity <= 0 || total <= 0;
         }

                 // Order'ƒ± execute et
        async function executeOrder() {
            if (!window.currentTradingCoin) {
                showNotification('Coin bilgisi bulunamadƒ±', 'error');
                return;
            }
            
            const direction = document.querySelector('.direction-btn.active').dataset.direction;
            const quantity = parseFloat(document.getElementById('orderQuantity').value);
            const currentPrice = window.currentTradingCoin.price * 30; // USD -> TL
            
            if (!quantity || quantity <= 0) {
                showNotification('Ge√ßerli bir miktar giriniz', 'error');
                return;
            }
            
            // Loading state
            const executeBtn = document.getElementById('executeOrderBtn');
            const originalText = executeBtn.innerHTML;
            executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒ∞≈üleniyor...';
            executeBtn.disabled = true;
            
            try {
                const formData = new FormData();
                formData.append('coin_id', window.currentTradingCoin.id);
                formData.append('miktar', quantity);
                formData.append('fiyat', currentPrice);
                
                const response = await fetch(`backend/user/trading.php?action=${direction}`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const directionText = direction === 'buy' ? 'SATIN ALMA' : 'SATIM';
                    const totalAmount = result.data.toplam_tutar;
                    
                    showNotification(
                        `‚úÖ ${directionText} ƒ∞≈ülemi Ba≈üarƒ±lƒ±!\n` +
                        `${quantity} ${window.currentTradingCoin.symbol} - ‚Ç∫${totalAmount.toLocaleString('tr-TR')}`,
                        'success'
                    );
                    
                    // Modal'ƒ± kapat
                    closeTradingModal();
                    
                    // Kullanƒ±cƒ± bilgilerini ve portf√∂y√º g√ºncelle
                    loadUserInfo();
                    if (typeof loadPortfolio === 'function') {
                        loadPortfolio();
                    }
                    
                } else {
                    showNotification(`‚ùå ƒ∞≈ülem Hatasƒ±: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Trading API Error:', error);
                showNotification('‚ùå Baƒülantƒ± hatasƒ±. L√ºtfen tekrar deneyin.', 'error');
            } finally {
                // Loading state'i kaldƒ±r
                executeBtn.innerHTML = originalText;
                executeBtn.disabled = false;
            }
        }

                 // Sahte grafik y√ºkle
         function loadFakeChart(symbol) {
             const fakeChart = document.getElementById('fake-chart');
             const placeholder = document.getElementById('chartPlaceholder');
             
             // Placeholder'ƒ± gizle
             placeholder.style.display = 'none';
             fakeChart.style.display = 'block';
             
             // Canvas grafik √ßiz
             createFakePriceChart(symbol);
         }
         
         // Sahte fiyat grafiƒüi olu≈ütur
         function createFakePriceChart(symbol) {
             const canvas = document.getElementById('priceChart');
             const ctx = canvas.getContext('2d');
             
             // Canvas boyutlarƒ±nƒ± ayarla
             canvas.width = canvas.offsetWidth;
             canvas.height = canvas.offsetHeight;
             
             // Ger√ßek√ßi fiyat verisi olu≈ütur
             const prices = generateFakePriceData();
             drawPriceChart(ctx, prices, symbol);
             
             // Animasyonlu fiyat g√ºncellemesi
             setInterval(() => {
                 updateFakePrice(ctx, symbol);
             }, 3000);
         }
         
         // Sahte fiyat verisi olu≈ütur
         function generateFakePriceData() {
             const data = [];
             let price = 45000 + Math.random() * 5000;
             
             for (let i = 0; i < 100; i++) {
                 price += (Math.random() - 0.5) * 200;
                 data.push({
                     x: i,
                     y: price
                 });
             }
             
             return data;
         }
         
         // Grafik √ßiz
         function drawPriceChart(ctx, data, symbol) {
             const width = ctx.canvas.width;
             const height = ctx.canvas.height;
             
             // Arka plan
             ctx.fillStyle = '#141927';
             ctx.fillRect(0, 0, width, height);
             
             // Grid √ßizgileri
             ctx.strokeStyle = '#2a2f3e';
             ctx.lineWidth = 1;
             
             for (let i = 0; i <= 10; i++) {
                 const y = (height / 10) * i;
                 ctx.beginPath();
                 ctx.moveTo(0, y);
                 ctx.lineTo(width, y);
                 ctx.stroke();
             }
             
             // Fiyat √ßizgisi
             ctx.strokeStyle = '#00d4aa';
             ctx.lineWidth = 2;
             ctx.beginPath();
             
             data.forEach((point, index) => {
                 const x = (width / data.length) * index;
                 const y = height - ((point.y - 40000) / 10000) * height;
                 
                 if (index === 0) {
                     ctx.moveTo(x, y);
                 } else {
                     ctx.lineTo(x, y);
                 }
             });
             
             ctx.stroke();
             
             // Fiyat etiketi
             ctx.fillStyle = '#ffffff';
             ctx.font = '14px Arial';
             ctx.fillText(`${symbol.toUpperCase()}: ‚Ç∫${data[data.length - 1].y.toFixed(2)}`, 10, 20);
         }
         
         // Fiyat g√ºncelle
         function updateFakePrice(ctx, symbol) {
             const currentPrice = 45000 + Math.random() * 5000;
             
             // Fiyat etiketini g√ºncelle
             ctx.fillStyle = '#141927';
             ctx.fillRect(0, 0, 200, 30);
             
             ctx.fillStyle = '#ffffff';
             ctx.font = '14px Arial';
             ctx.fillText(`${symbol.toUpperCase()}: ‚Ç∫${currentPrice.toFixed(2)}`, 10, 20);
         }
         
         // Advanced options toggle
        function toggleAdvancedOptions() {
            const content = document.getElementById('advancedContent');
            const icon = document.querySelector('.advanced-toggle i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Modern coin rendering - her iki platform i√ßin
        function renderModernCoins(coins) {
            const marketLoader = document.getElementById('marketLoader');
            const desktopGrid = document.getElementById('desktopCoinsGrid');
            const mobileGrid = document.getElementById('mobileCoinsGrid');
            
            marketLoader.style.display = 'none';
            
            // Desktop grid render
            renderDesktopCoins(coins, desktopGrid);
            
            // Mobile grid render
            renderMobileCoins(coins, mobileGrid);
            
            // Grids'i g√∂ster
            desktopGrid.style.display = window.innerWidth > 768 ? 'grid' : 'none';
            mobileGrid.style.display = window.innerWidth <= 768 ? 'grid' : 'none';
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('tr-TR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Desktop coin kartlarƒ± render et
        function renderDesktopCoins(coins, container) {
            container.innerHTML = '';
            
            coins.forEach((coin, index) => {
                const priceChangeClass = coin.price_change_24h >= 0 ? 'positive' : 'negative';
                const priceChangeIcon = coin.price_change_24h >= 0 ? '‚ñ≤' : '‚ñº';
                
                // Orijinal coin logolarƒ±
                const coinLogos = {
                    'BTC': 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png',
                    'ETH': 'https://assets.coingecko.com/coins/images/279/large/ethereum.png',
                    'BNB': 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png',
                    'ADA': 'https://assets.coingecko.com/coins/images/975/large/cardano.png',
                    'SOL': 'https://assets.coingecko.com/coins/images/4128/large/solana.png',
                    'XRP': 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png',
                    'DOT': 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png',
                    'DOGE': 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png',
                    'AVAX': 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png',
                    'SHIB': 'https://assets.coingecko.com/coins/images/11939/large/shiba.png',
                    'LINK': 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png',
                    'TRX': 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png',
                    'MATIC': 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png',
                    'LTC': 'https://assets.coingecko.com/coins/images/2/large/litecoin.png',
                    'BCH': 'https://assets.coingecko.com/coins/images/780/large/bitcoin-cash-circle.png',
                    'UNI': 'https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png',
                    'ATOM': 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png',
                    'XLM': 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png',
                    'VET': 'https://assets.coingecko.com/coins/images/1167/large/VeChain-Logo-768x725.png',
                    'FIL': 'https://assets.coingecko.com/coins/images/12817/large/filecoin.png',
                    'THETA': 'https://assets.coingecko.com/coins/images/2538/large/theta-token-logo.png',
                    'ICP': 'https://assets.coingecko.com/coins/images/14495/large/Internet_Computer_logo.png',
                    'ALGO': 'https://assets.coingecko.com/coins/images/4380/large/download.png',
                    'XTZ': 'https://assets.coingecko.com/coins/images/976/large/Tezos-logo.png',
                    'EGLD': 'https://assets.coingecko.com/coins/images/12335/large/egld-token-logo.png',
                    'AAVE': 'https://assets.coingecko.com/coins/images/12645/large/AAVE.png',
                    'EOS': 'https://assets.coingecko.com/coins/images/738/large/eos-eos-logo.png',
                    'XMR': 'https://assets.coingecko.com/coins/images/69/large/monero_logo.png',
                    'MANA': 'https://assets.coingecko.com/coins/images/878/large/decentraland-mana.png',
                    'SAND': 'https://assets.coingecko.com/coins/images/12129/large/sandbox_logo.jpg',
                    'CRO': 'https://assets.coingecko.com/coins/images/7310/large/cypto.png',
                    'NEAR': 'https://assets.coingecko.com/coins/images/10365/large/near_icon.png',
                    'APE': 'https://assets.coingecko.com/coins/images/24383/large/apecoin.jpg',
                    'LDO': 'https://assets.coingecko.com/coins/images/13573/large/Lido_DAO.png',
                    'USDT': 'https://assets.coingecko.com/coins/images/325/large/Tether.png',
                    'USDC': 'https://assets.coingecko.com/coins/images/6319/large/USD_Coin_icon.png',
                    'BUSD': 'https://assets.coingecko.com/coins/images/9576/large/BUSD.png',
                    'DAI': 'https://assets.coingecko.com/coins/images/9956/large/4943.png'
                };
                
                const logoUrl = coin.logo_url || coinLogos[coin.coin_kodu] || `https://via.placeholder.com/48/4fc3f7/ffffff?text=${coin.coin_kodu.charAt(0)}`;
                
                        const card = document.createElement('div');
                        card.className = 'desktop-coin-card';
                        card.onclick = () => openTradingModal(coin.id, coin.coin_adi, coin.current_price, 'buy', coin.coin_kodu);
                        
                        card.innerHTML = `
                            <div class="coin-card-header">
                                <div class="coin-info">
                                    <div class="coin-logo">
                                        <img src="${logoUrl}" alt="${coin.coin_adi}" 
                                             onerror="this.style.display='none'; this.parentNode.textContent='${coin.coin_kodu.charAt(0)}'">
                                    </div>
                                    <div class="coin-details">
                                        <h4>${coin.coin_adi}</h4>
                                        <span class="coin-symbol">${coin.coin_kodu}</span>
                                    </div>
                                </div>
                                <div class="coin-price">
                                    <div class="price">‚Ç∫${parseFloat(coin.current_price).toLocaleString('tr-TR', { 
                                        minimumFractionDigits: 2, 
                                        maximumFractionDigits: 2 
                                    })}</div>
                                    <div class="rank">#${index + 1}</div>
                                </div>
                            </div>
                    
                    <div class="coin-stats">
                        <div class="price-change ${priceChangeClass}">
                            <i class="fas fa-${coin.price_change_24h >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${parseFloat(coin.price_change_24h).toFixed(2)}%
                        </div>
                        <div class="volume-info">
                            Piyasa Deƒüeri: $${coin.market_cap ? (parseInt(coin.market_cap) / 1000000).toFixed(1) + 'M' : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="coin-actions">
                        <button class="trade-btn buy" onclick="event.stopPropagation(); openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'buy', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-up"></i> Alƒ±≈ü
                        </button>
                        <button class="trade-btn sell" onclick="event.stopPropagation(); openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'sell', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-down"></i> Satƒ±≈ü
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Mobil coin kartlarƒ± render et
        function renderMobileCoins(coins, container) {
            container.innerHTML = '';
            
            coins.forEach((coin, index) => {
                const priceChangeClass = coin.price_change_24h >= 0 ? 'positive' : 'negative';
                const priceChangeIcon = coin.price_change_24h >= 0 ? '‚ñ≤' : '‚ñº';
                
                // Orijinal coin logolarƒ±
                const coinLogos = {
                    'BTC': 'https://assets.coingecko.com/coins/images/1/large/bitcoin.png',
                    'ETH': 'https://assets.coingecko.com/coins/images/279/large/ethereum.png',
                    'BNB': 'https://assets.coingecko.com/coins/images/825/large/bnb-icon2_2x.png',
                    'ADA': 'https://assets.coingecko.com/coins/images/975/large/cardano.png',
                    'SOL': 'https://assets.coingecko.com/coins/images/4128/large/solana.png',
                    'XRP': 'https://assets.coingecko.com/coins/images/44/large/xrp-symbol-white-128.png',
                    'DOT': 'https://assets.coingecko.com/coins/images/12171/large/polkadot.png',
                    'DOGE': 'https://assets.coingecko.com/coins/images/5/large/dogecoin.png',
                    'AVAX': 'https://assets.coingecko.com/coins/images/12559/large/Avalanche_Circle_RedWhite_Trans.png',
                    'SHIB': 'https://assets.coingecko.com/coins/images/11939/large/shiba.png',
                    'LINK': 'https://assets.coingecko.com/coins/images/877/large/chainlink-new-logo.png',
                    'TRX': 'https://assets.coingecko.com/coins/images/1094/large/tron-logo.png',
                    'MATIC': 'https://assets.coingecko.com/coins/images/4713/large/matic-token-icon.png',
                    'LTC': 'https://assets.coingecko.com/coins/images/2/large/litecoin.png',
                    'BCH': 'https://assets.coingecko.com/coins/images/780/large/bitcoin-cash-circle.png',
                    'UNI': 'https://assets.coingecko.com/coins/images/12504/large/uniswap-uni.png',
                    'ATOM': 'https://assets.coingecko.com/coins/images/1481/large/cosmos_hub.png',
                    'XLM': 'https://assets.coingecko.com/coins/images/100/large/Stellar_symbol_black_RGB.png',
                    'VET': 'https://assets.coingecko.com/coins/images/1167/large/VeChain-Logo-768x725.png',
                    'FIL': 'https://assets.coingecko.com/coins/images/12817/large/filecoin.png',
                    'THETA': 'https://assets.coingecko.com/coins/images/2538/large/theta-token-logo.png',
                    'ICP': 'https://assets.coingecko.com/coins/images/14495/large/Internet_Computer_logo.png',
                    'ALGO': 'https://assets.coingecko.com/coins/images/4380/large/download.png',
                    'XTZ': 'https://assets.coingecko.com/coins/images/976/large/Tezos-logo.png',
                    'EGLD': 'https://assets.coingecko.com/coins/images/12335/large/egld-token-logo.png',
                    'AAVE': 'https://assets.coingecko.com/coins/images/12645/large/AAVE.png',
                    'EOS': 'https://assets.coingecko.com/coins/images/738/large/eos-eos-logo.png',
                    'XMR': 'https://assets.coingecko.com/coins/images/69/large/monero_logo.png',
                    'MANA': 'https://assets.coingecko.com/coins/images/878/large/decentraland-mana.png',
                    'SAND': 'https://assets.coingecko.com/coins/images/12129/large/sandbox_logo.jpg',
                    'CRO': 'https://assets.coingecko.com/coins/images/7310/large/cypto.png',
                    'NEAR': 'https://assets.coingecko.com/coins/images/10365/large/near_icon.png',
                    'APE': 'https://assets.coingecko.com/coins/images/24383/large/apecoin.jpg',
                    'LDO': 'https://assets.coingecko.com/coins/images/13573/large/Lido_DAO.png',
                    'USDT': 'https://assets.coingecko.com/coins/images/325/large/Tether.png',
                    'USDC': 'https://assets.coingecko.com/coins/images/6319/large/USD_Coin_icon.png',
                    'BUSD': 'https://assets.coingecko.com/coins/images/9576/large/BUSD.png',
                    'DAI': 'https://assets.coingecko.com/coins/images/9956/large/4943.png'
                };
                
                const logoUrl = coin.logo_url || coinLogos[coin.coin_kodu] || `https://via.placeholder.com/50/4fc3f7/ffffff?text=${coin.coin_kodu.charAt(0)}`;
                
                const card = document.createElement('div');
                card.className = 'mobile-coin-card';
                card.innerHTML = `
                    <div class="mobile-coin-header">
                        <div class="mobile-coin-info">
                            <div class="mobile-coin-logo">
                                <img src="${logoUrl}" alt="${coin.coin_adi}" 
                                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;"
                                     onerror="this.style.display='none'; this.parentNode.textContent='${coin.coin_kodu.charAt(0)}'">
                            </div>
                            <div class="mobile-coin-details">
                                <h3>${coin.coin_adi}</h3>
                                <span class="coin-symbol">${coin.coin_kodu}</span>
                            </div>
                        </div>
                        <div class="mobile-coin-price">
                            $${parseFloat(coin.current_price).toLocaleString('en-US', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 6 
                            })}
                        </div>
                    </div>
                    
                    <div class="mobile-coin-stats">
                        <div class="mobile-coin-change ${priceChangeClass}">
                            ${priceChangeIcon} ${parseFloat(coin.price_change_24h).toFixed(2)}%
                        </div>
                        <div class="mobile-coin-volume">
                            Vol: $${coin.market_cap ? (parseInt(coin.market_cap) / 1000000).toFixed(1) + 'M' : 'N/A'}
                        </div>
                    </div>
                    
                    <div class="mobile-coin-actions">
                        <button class="mobile-trade-btn buy" onclick="openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'buy', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-up"></i> Alƒ±≈ü
                        </button>
                        <button class="mobile-trade-btn sell" onclick="openTradingModal('${coin.id}', '${coin.coin_adi}', '${coin.current_price}', 'sell', '${coin.coin_kodu}')">
                            <i class="fas fa-arrow-down"></i> Satƒ±≈ü
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
         }

         // Global chart variables
         let chartAnimationFrame;
         let chartData = {
             priceData: [],
             timeLabels: [],
             animationProgress: 0,
             isAnimating: false,
             lastUpdate: 0,
             coinId: '',
             basePrice: 0
         };

         // Animasyonlu grafik √ßizme fonksiyonu
         function drawPriceChart(coinId, currentPrice) {
             const canvas = document.getElementById('priceChart');
             const placeholder = document.getElementById('chartPlaceholder');
             const ctx = canvas.getContext('2d');
             
             // Canvas boyutlarƒ±nƒ± ayarla
             const rect = canvas.getBoundingClientRect();
             canvas.width = rect.width * window.devicePixelRatio;
             canvas.height = rect.height * window.devicePixelRatio;
             ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
             
             // Placeholder'ƒ± gizle
             placeholder.style.display = 'none';
             canvas.style.display = 'block';
             
             // Chart data'yƒ± inicialize et
             initializeChartData(coinId, currentPrice);
             
             // Animasyonu ba≈ülat
             startChartAnimation(ctx, rect);
         }

         // Chart data'yƒ± inicialize et
         function initializeChartData(coinId, currentPrice) {
             chartData.coinId = coinId;
             chartData.basePrice = parseFloat(currentPrice);
             chartData.priceData = [];
             chartData.timeLabels = [];
             chartData.animationProgress = 0;
             chartData.isAnimating = true;
             
             const dataPoints = 50;
             
             for (let i = dataPoints; i >= 0; i--) {
                 const variation = (Math.random() - 0.5) * 0.15; // %15 varyasyon
                 const trend = Math.sin((i / dataPoints) * Math.PI * 2) * 0.05; // Sin√ºs trend
                 const noise = (Math.random() - 0.5) * 0.03; // K√º√ß√ºk g√ºr√ºlt√º
                 const price = chartData.basePrice * (1 + variation + trend + noise);
                 chartData.priceData.push(price);
                 
                 const time = new Date();
                 time.setMinutes(time.getMinutes() - i * 5);
                 chartData.timeLabels.push(time.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
             }
         }

         // Chart animasyonunu ba≈ülat
         function startChartAnimation(ctx, rect) {
             const startTime = performance.now();
             
             function animate(currentTime) {
                 const elapsed = currentTime - startTime;
                 const duration = 2000; // 2 saniye animasyon
                 
                 chartData.animationProgress = Math.min(elapsed / duration, 1);
                 
                 // Canvas'ƒ± temizle
                 ctx.clearRect(0, 0, rect.width, rect.height);
                 
                 // Grafiƒüi √ßiz
                 drawAnimatedChart(ctx, rect);
                 
                 if (chartData.animationProgress < 1) {
                     chartAnimationFrame = requestAnimationFrame(animate);
                 } else {
                     // Animasyon tamamlandƒ±, canlƒ± g√ºncellemeleri ba≈ülat
                     startLiveUpdates(ctx, rect);
                 }
             }
             
             chartAnimationFrame = requestAnimationFrame(animate);
         }

         // Animasyonlu chart √ßiz
         function drawAnimatedChart(ctx, rect) {
             const padding = 40;
             const chartWidth = rect.width - padding * 2;
             const chartHeight = rect.height - padding * 2;
             
             // Min/Max deƒüerleri bul
             const minPrice = Math.min(...chartData.priceData);
             const maxPrice = Math.max(...chartData.priceData);
             const priceRange = maxPrice - minPrice;
             
             // Grid √ßiz (fade in)
             const gridOpacity = chartData.animationProgress * 0.1;
             ctx.strokeStyle = `rgba(255, 255, 255, ${gridOpacity})`;
             ctx.lineWidth = 1;
             
             // Yatay grid √ßizgileri
             for (let i = 0; i <= 5; i++) {
                 const y = padding + (chartHeight / 5) * i;
                 ctx.beginPath();
                 ctx.moveTo(padding, y);
                 ctx.lineTo(padding + chartWidth, y);
                 ctx.stroke();
                 
                 // Fiyat etiketleri (fade in)
                 const price = maxPrice - (priceRange / 5) * i;
                 ctx.fillStyle = `rgba(136, 150, 171, ${chartData.animationProgress})`;
                 ctx.font = '12px Inter, sans-serif';
                 ctx.textAlign = 'right';
                 ctx.fillText('$' + price.toFixed(2), padding - 10, y + 4);
             }
             
             // Dikey grid √ßizgileri
             for (let i = 0; i <= 10; i++) {
                 const x = padding + (chartWidth / 10) * i;
                 ctx.beginPath();
                 ctx.moveTo(x, padding);
                 ctx.lineTo(x, padding + chartHeight);
                 ctx.stroke();
             }
             
             // Animasyonlu fiyat √ßizgisi
             const dataPoints = chartData.priceData.length;
             const currentPoints = Math.floor(dataPoints * chartData.animationProgress);
             
             if (currentPoints > 1) {
                 // Ana √ßizgi
                 ctx.strokeStyle = '#4fc3f7';
                 ctx.lineWidth = 3;
                 ctx.beginPath();
                 
                 for (let i = 0; i < currentPoints; i++) {
                     const x = padding + (chartWidth / (dataPoints - 1)) * i;
                     const y = padding + chartHeight - ((chartData.priceData[i] - minPrice) / priceRange) * chartHeight;
                     
                     if (i === 0) {
                         ctx.moveTo(x, y);
                     } else {
                         ctx.lineTo(x, y);
                     }
                 }
                 ctx.stroke();
                 
                 // Gradient fill (animasyonlu)
                 const gradient = ctx.createLinearGradient(0, padding, 0, padding + chartHeight);
                 const fillOpacity = chartData.animationProgress * 0.3;
                 gradient.addColorStop(0, `rgba(79, 195, 247, ${fillOpacity})`);
                 gradient.addColorStop(1, `rgba(79, 195, 247, ${fillOpacity * 0.1})`);
                 
                 ctx.fillStyle = gradient;
                 ctx.beginPath();
                 
                 for (let i = 0; i < currentPoints; i++) {
                     const x = padding + (chartWidth / (dataPoints - 1)) * i;
                     const y = padding + chartHeight - ((chartData.priceData[i] - minPrice) / priceRange) * chartHeight;
                     
                     if (i === 0) {
                         ctx.moveTo(x, y);
                     } else {
                         ctx.lineTo(x, y);
                     }
                 }
                 
                 // Fill to bottom
                 if (currentPoints > 0) {
                     const lastX = padding + (chartWidth / (dataPoints - 1)) * (currentPoints - 1);
                     ctx.lineTo(lastX, padding + chartHeight);
                     ctx.lineTo(padding, padding + chartHeight);
                 }
                 ctx.closePath();
                 ctx.fill();
                 
                 // Animating dot at the end
                 if (currentPoints > 0) {
                     const lastIndex = currentPoints - 1;
                     const lastX = padding + (chartWidth / (dataPoints - 1)) * lastIndex;
                     const lastY = padding + chartHeight - ((chartData.priceData[lastIndex] - minPrice) / priceRange) * chartHeight;
                     
                     // Pulsing effect
                     const pulseScale = 1 + Math.sin(performance.now() * 0.01) * 0.3;
                     
                     ctx.beginPath();
                     ctx.arc(lastX, lastY, 6 * pulseScale, 0, 2 * Math.PI);
                     ctx.fillStyle = '#4fc3f7';
                     ctx.fill();
                     ctx.strokeStyle = '#ffffff';
                     ctx.lineWidth = 2;
                     ctx.stroke();
                 }
             }
             
             // Ba≈ülƒ±k (fade in)
             ctx.fillStyle = `rgba(255, 255, 255, ${chartData.animationProgress})`;
             ctx.font = 'bold 16px Inter, sans-serif';
             ctx.textAlign = 'left';
             ctx.fillText(`${chartData.coinId.toUpperCase()}/USD Price Chart`, padding, 25);
             
             // Son fiyat (fade in)
             if (chartData.priceData.length > 0) {
                 ctx.fillStyle = `rgba(79, 195, 247, ${chartData.animationProgress})`;
                 ctx.font = 'bold 14px Inter, sans-serif';
                 ctx.textAlign = 'right';
                 const currentIndex = Math.min(Math.floor(chartData.priceData.length * chartData.animationProgress), chartData.priceData.length - 1);
                 ctx.fillText('$' + chartData.priceData[currentIndex].toFixed(6), rect.width - padding, 25);
             }
         }

         // Canlƒ± g√ºncellemeleri ba≈ülat
         function startLiveUpdates(ctx, rect) {
             function updatePrice() {
                 // Yeni fiyat noktasƒ± ekle
                 const lastPrice = chartData.priceData[chartData.priceData.length - 1];
                 const change = (Math.random() - 0.5) * 0.02; // %2 deƒüi≈üim
                 const newPrice = lastPrice * (1 + change);
                 
                 // Array'i kaydƒ±r ve yeni fiyat ekle
                 chartData.priceData.shift();
                 chartData.priceData.push(newPrice);
                 
                 // Time label'ƒ± g√ºncelle
                 chartData.timeLabels.shift();
                 const now = new Date();
                 chartData.timeLabels.push(now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
                 
                 // Grafiƒüi yeniden √ßiz
                 ctx.clearRect(0, 0, rect.width, rect.height);
                 chartData.animationProgress = 1; // Tam g√∂r√ºn√ºr
                 drawAnimatedChart(ctx, rect);
                 
                 // Modal price'ƒ± g√ºncelle
                 document.getElementById('modalCoinPrice').textContent = `$${newPrice.toLocaleString()}`;
                 
                 // 3 saniye sonra tekrar g√ºncelle
                 setTimeout(updatePrice, 3000);
             }
             
             // ƒ∞lk g√ºncellemeyi 3 saniye sonra ba≈ülat
             setTimeout(updatePrice, 3000);
         }

                   // Modal kapandƒ±ƒüƒ±nda animasyonu durdur
          function stopChartAnimation() {
              if (chartAnimationFrame) {
                  cancelAnimationFrame(chartAnimationFrame);
                  chartAnimationFrame = null;
              }
              chartData.isAnimating = false;
          }

          // Timeframe deƒüi≈ütir
          function updateChartTimeframe(timeframe) {
              if (!chartData.isAnimating && chartData.priceData.length > 0) {
                  // Farklƒ± timeframe'ler i√ßin farklƒ± data pattern'leri
                  const patterns = {
                      '1m': { volatility: 0.01, trend: 0.02 },
                      '5m': { volatility: 0.02, trend: 0.03 },
                      '15m': { volatility: 0.03, trend: 0.04 },
                      '1h': { volatility: 0.05, trend: 0.06 },
                      '4h': { volatility: 0.08, trend: 0.08 },
                      '1d': { volatility: 0.12, trend: 0.10 }
                  };
                  
                  const pattern = patterns[timeframe] || patterns['1h'];
                  
                  // Yeni data generate et
                  const dataPoints = 50;
                  const newPriceData = [];
                  
                  for (let i = 0; i < dataPoints; i++) {
                      const variation = (Math.random() - 0.5) * pattern.volatility;
                      const trend = Math.sin((i / dataPoints) * Math.PI * 3) * pattern.trend;
                      const noise = (Math.random() - 0.5) * (pattern.volatility * 0.3);
                      const price = chartData.basePrice * (1 + variation + trend + noise);
                      newPriceData.push(price);
                  }
                  
                  chartData.priceData = newPriceData;
                  
                  // Grafiƒüi smooth transition ile g√ºncelle
                  const canvas = document.getElementById('priceChart');
                  const ctx = canvas.getContext('2d');
                  const rect = canvas.getBoundingClientRect();
                  
                  // Kƒ±sa animasyonla g√ºncelle
                  let progress = 0;
                  function updateTransition() {
                      progress += 0.1;
                      if (progress <= 1) {
                          ctx.clearRect(0, 0, rect.width, rect.height);
                          chartData.animationProgress = 1;
                          drawAnimatedChart(ctx, rect);
                          requestAnimationFrame(updateTransition);
                      }
                  }
                  requestAnimationFrame(updateTransition);
              }
          }

         // Filter fonksiyonlarƒ±
        function initializeMarketFilters() {
            const filterChips = document.querySelectorAll('.filter-chip');
            filterChips.forEach(chip => {
                chip.addEventListener('click', function() {
                    // Aktif filter'ƒ± deƒüi≈ütir
                    filterChips.forEach(f => f.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Filter uygula (≈üimdilik demo)
                    const filter = this.dataset.filter;
                    console.log('Filter uygulandƒ±:', filter);
                    
                    // Burada ger√ßek filtreleme mantƒ±ƒüƒ± olacak
                    // fetchMarketData() √ßaƒürƒ±sƒ± ile backend'e filter parametresi g√∂nderilebilir
                });
            });
        }
        
        // Search input i√ßin debounced arama
        function initializeCoinSearch() {
            const searchInput = document.getElementById('coinSearch');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    fetchMarketData();
                }, 500); // 500ms debounce
            });
        }
        
        // Responsive listener
        function initializeResponsiveListeners() {
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    // Grid g√∂r√ºn√ºmlerini tekrar d√ºzenle
                    const desktopGrid = document.getElementById('desktopCoinsGrid');
                    const mobileGrid = document.getElementById('mobileCoinsGrid');
                    
                    if (desktopGrid && mobileGrid) {
                        if (window.innerWidth > 768) {
                            desktopGrid.style.display = 'grid';
                            mobileGrid.style.display = 'none';
                        } else {
                            desktopGrid.style.display = 'none';
                            mobileGrid.style.display = 'grid';
                        }
                    }
                }, 250);
            });
        }
        
        // Page init
        function initializeMarketPage() {
            initializeMarketFilters();
            initializeCoinSearch();
            initializeResponsiveListeners();
            
            // ƒ∞lk veri y√ºklemesi
            fetchMarketData();
          }

         // Sayfa y√ºklendiƒüinde piyasalarƒ± y√ºkle
        async function refreshMarketData() {
            await fetchMarketData();
        }

        // Trading sistem deƒüi≈ükenleri
        let selectedForexPair = null;
        let currentTradeDirection = 'long';

        // Trading sistemini ba≈ülat
        function initTrading() {
            loadForexPairs();
            setupTradingEventListeners();
        }

        // Forex pair'leri y√ºkle
        async function loadForexPairs() {
            const forexLoader = document.getElementById('forexLoader');
            const forexPairsList = document.getElementById('forexPairsList');

            try {
                // ≈ûimdilik mock data kullan - sonra backend endpoint eklenecek
                const mockForexData = [
                    { id: 1, symbol: 'EURUSD', display_name: 'EUR/USD', category: 'major', current_price: 1.08500, bid_price: 1.08480, ask_price: 1.08520, spread: 4.0, pip_value: 0.0001, max_leverage: 500 },
                    { id: 2, symbol: 'GBPUSD', display_name: 'GBP/USD', category: 'major', current_price: 1.26800, bid_price: 1.26780, ask_price: 1.26820, spread: 4.0, pip_value: 0.0001, max_leverage: 500 },
                    { id: 3, symbol: 'USDJPY', display_name: 'USD/JPY', category: 'major', current_price: 148.250, bid_price: 148.230, ask_price: 148.270, spread: 4.0, pip_value: 0.01, max_leverage: 500 },
                    { id: 4, symbol: 'XAUUSD', display_name: 'Gold', category: 'commodities', current_price: 2685.50, bid_price: 2685.00, ask_price: 2686.00, spread: 10.0, pip_value: 0.01, max_leverage: 200 },
                    { id: 5, symbol: 'US30', display_name: 'Dow Jones', category: 'indices', current_price: 42580.50, bid_price: 42578.0, ask_price: 42583.0, spread: 5.0, pip_value: 1.0, max_leverage: 100 }
                ];

                renderForexPairs(mockForexData);
                forexLoader.style.display = 'none';
                forexPairsList.style.display = 'block';

            } catch (error) {
                console.error('Forex pairs y√ºkleme hatasƒ±:', error);
                forexPairsList.innerHTML = '<p style="color: #ff4757; text-align: center; padding: 20px;">Forex verileri y√ºklenemedi</p>';
                forexLoader.style.display = 'none';
                forexPairsList.style.display = 'block';
            }
        }

        // Forex pair'leri renderla
        function renderForexPairs(pairs) {
            const container = document.getElementById('forexPairsList');
            container.innerHTML = '';

            pairs.forEach(pair => {
                const priceDirection = Math.random() > 0.5 ? 'up' : 'down';
                const priceColor = priceDirection === 'up' ? '#00d4aa' : '#ff4757';
                const priceIcon = priceDirection === 'up' ? '‚ñ≤' : '‚ñº';

                const pairElement = document.createElement('div');
                pairElement.className = 'forex-pair-item';
                pairElement.dataset.pairId = pair.id;
                pairElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div class="pair-symbol">${pair.display_name}</div>
                            <div class="pair-category">${pair.category} ‚Ä¢ Max Leverage 1:${pair.max_leverage}</div>
                        </div>
                        <div style="text-align: right; min-width: 120px;">
                            <div class="pair-price ${priceDirection === 'up' ? 'price-up' : 'price-down'}">
                                ${pair.current_price} ${priceIcon}
                            </div>
                            <div class="pair-spread">Spread ${pair.spread} pips</div>
                        </div>
                    </div>
                `;

                pairElement.addEventListener('click', () => selectForexPair(pair));
                container.appendChild(pairElement);
            });
        }

        // Forex pair se√ß
        function selectForexPair(pair) {
            selectedForexPair = pair;

            // Se√ßili pair'i g√∂rsel olarak i≈üaretle
            document.querySelectorAll('.forex-pair-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-pair-id="${pair.id}"]`).classList.add('selected');

            // Trading form'unu aktif et
            document.getElementById('tradingForm').style.display = 'block';
            document.getElementById('noSelectionMessage').style.display = 'none';

            // Pair bilgilerini g√ºncelle
            document.getElementById('selectedPairInfo').innerHTML = `
                <strong>${pair.display_name}</strong> | Price: ${pair.current_price} | Spread: ${pair.spread} pips | Max Leverage: 1:${pair.max_leverage}
            `;

            // Kaldƒ±ra√ß se√ßeneklerini g√ºncelle
            updateLeverageOptions(pair.max_leverage);

            // Hesaplamalarƒ± g√ºncelle
            updateTradeCalculations();
        }

        // Kaldƒ±ra√ß se√ßeneklerini g√ºncelle
        function updateLeverageOptions(maxLeverage) {
            const leverageSelect = document.getElementById('leverageRatio');
            leverageSelect.innerHTML = '';

            const leverageOptions = [10, 50, 100, 200, 500].filter(lev => lev <= maxLeverage);
            leverageOptions.forEach(leverage => {
                const option = document.createElement('option');
                option.value = leverage;
                option.textContent = `1:${leverage}`;
                if (leverage === 100 && leverage <= maxLeverage) option.selected = true;
                leverageSelect.appendChild(option);
            });
        }

        // Trade hesaplamalarƒ±nƒ± g√ºncelle
        function updateTradeCalculations() {
            if (!selectedForexPair) return;

            const lotSize = parseFloat(document.getElementById('lotSize').value);
            const leverage = parseInt(document.getElementById('leverageRatio').value);

            // Basit margin hesaplamasƒ±
            const contractSize = 100000; // Standard lot size
            const price = selectedForexPair.current_price;
            const requiredMargin = (lotSize * contractSize * price) / leverage;

            // Pip deƒüeri hesaplama
            const pipValue = lotSize * contractSize * selectedForexPair.pip_value;

            // DOM'u g√ºncelle
            document.getElementById('requiredMargin').textContent = `$${requiredMargin.toFixed(2)}`;
            document.getElementById('pipValue').textContent = `$${pipValue.toFixed(2)}`;
            document.getElementById('spreadValue').textContent = `${selectedForexPair.spread} pips`;
            document.getElementById('contractSize').textContent = `${(lotSize * contractSize).toLocaleString()}`;

            // Trade butonunu aktif et
            document.getElementById('openTradeBtn').disabled = false;
        }

        // Trading event listener'larƒ± kurulum
        function setupTradingEventListeners() {
            // Direction buttons
            document.getElementById('longBtn').addEventListener('click', function() {
                setTradeDirection('long');
            });
            document.getElementById('shortBtn').addEventListener('click', function() {
                setTradeDirection('short');
            });

            // Form deƒüi≈üiklikleri
            ['lotSize', 'leverageRatio'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateTradeCalculations);
            });

            // Trade a√ßma butonu
            document.getElementById('openTradeBtn').addEventListener('click', openTrade);

            // Kategori filtreleri
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Filter logic burada eklenecek
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // Trade direction deƒüi≈ütir
        function setTradeDirection(direction) {
            currentTradeDirection = direction;
            document.querySelectorAll('.trade-direction-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(direction + 'Btn').classList.add('active');
        }

        // Trade a√ß
        async function openTrade() {
            if (!selectedForexPair) {
                alert('L√ºtfen bir forex pair se√ßin');
                return;
            }

            const tradeData = {
                pair_id: selectedForexPair.id,
                trade_type: currentTradeDirection,
                lot_size: parseFloat(document.getElementById('lotSize').value),
                leverage_ratio: parseInt(document.getElementById('leverageRatio').value),
                stop_loss: document.getElementById('stopLoss').value || null,
                take_profit: document.getElementById('takeProfit').value || null
            };

            try {
                // ≈ûimdilik mock response - sonra ger√ßek backend endpoint eklenecek
                console.log('Trade a√ßƒ±lƒ±yor:', tradeData);
                
                alert(`üöÄ ${selectedForexPair.display_name} i√ßin ${currentTradeDirection.toUpperCase()} pozisyonu a√ßƒ±ldƒ±!\n\nLot: ${tradeData.lot_size}\nKaldƒ±ra√ß: 1:${tradeData.leverage_ratio}\n\nPozisyon y√∂netimi i√ßin backend entegrasyonu yakƒ±nda...`);
                
                // Form'u resetle
                resetTradingForm();
                
            } catch (error) {
                console.error('Trade a√ßma hatasƒ±:', error);
                alert('Trade a√ßƒ±lƒ±rken hata olu≈ütu');
            }
        }

        // Trading form'unu resetle
        function resetTradingForm() {
            document.getElementById('stopLoss').value = '';
            document.getElementById('takeProfit').value = '';
            updateTradeCalculations();
        }

        // Pozisyonlarƒ± yenile
        function refreshPositions() {
            const positionsLoader = document.getElementById('positionsLoader');
            const positionsList = document.getElementById('openPositionsList');
            
            positionsLoader.style.display = 'block';
            positionsList.style.display = 'none';
            
            // Mock pozisyon verisi
            setTimeout(() => {
                positionsList.innerHTML = `
                    <div style="text-align: center; color: #8b8fa3; padding: 30px;">
                        <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 15px; opacity: 0.3;"></i>
                        <p>A√ßƒ±k pozisyon bulunmuyor</p>
                        <small>Forex pair se√ßerek trading ba≈ülayabilirsiniz</small>
                    </div>
                `;
                positionsLoader.style.display = 'none';
                positionsList.style.display = 'block';
            }, 1000);
        }
        
        // Sayfa y√ºklendiƒüinde initialization yap
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Trading Dashboard ba≈ülatƒ±lƒ±yor...');
            
            // Market sayfasƒ± i√ßin √∂zel initialization
            if (document.getElementById('coinSearch')) {
                initializeMarketPage();
            }
            
            // Trading sistemi ba≈ülat
            if (document.getElementById('forexPairsContainer')) {
                initTrading();
            }
            
            // Kullanƒ±cƒ± verilerini y√ºkle
            loadUserInfo();
        });

        // Kaldƒ±ra√ßlƒ± ƒ∞≈ülem Sistemi
        let currentLeverageMode = 'spot';
        let currentLeverage = 1;
        let currentPositionType = 'long';
        let currentCoinPrice = 0;
        let currentCoinSymbol = 'BTC';

        // Trading modal'ƒ± ba≈ülat
        function initTradingModal() {
            // Mode tab event listeners
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentLeverageMode = this.dataset.mode;
                    toggleLeverageSelection();
                    updateTradingCalculations();
                    
                    // Execute button'ƒ± g√ºncelle
                    setTradingDirection(window.currentTradingCoin?.direction || 'buy');
                });
            });

            // Leverage button event listeners
            document.querySelectorAll('.leverage-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.leverage-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentLeverage = parseFloat(this.dataset.leverage);
                    updateTradingCalculations();
                });
            });

            // Position type event listeners
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentPositionType = this.dataset.position;
                    updateTradingCalculations();
                    
                    // Execute button metnini g√ºncelle
                    if (currentLeverageMode === 'leverage') {
                        const executeText = document.getElementById('executeText');
                        const positionText = currentPositionType === 'long' ? 'Long Pozisyon A√ß' : 'Short Pozisyon A√ß';
                        executeText.textContent = `${currentCoinSymbol} ${positionText}`;
                        
                        const executeBtn = document.getElementById('executeOrderBtn');
                        executeBtn.className = `execute-btn ${currentPositionType === 'long' ? 'buy-order' : 'sell-order'}`;
                    }
                });
            });
        }

        // Kaldƒ±ra√ß se√ßimini g√∂ster/gizle
        function toggleLeverageSelection() {
            const leverageSelection = document.getElementById('leverageSelection');
            const leverageSummaryRows = document.getElementById('leverageSummaryRows');
            const executeBtn = document.getElementById('executeOrderBtn');
            
            if (currentLeverageMode === 'leverage') {
                leverageSelection.style.display = 'block';
                leverageSummaryRows.style.display = 'block';
                
                // Kaldƒ±ra√ß modunda execute button'ƒ± aktif et
                executeBtn.disabled = false;
            } else {
                leverageSelection.style.display = 'none';
                leverageSummaryRows.style.display = 'none';
            }
        }

        // Trading hesaplamalarƒ±nƒ± g√ºncelle
        function updateTradingCalculations() {
            if (currentLeverageMode === 'leverage') {
                updateLeverageCalculations();
            }
        }

        // Kaldƒ±ra√ß hesaplamalarƒ±nƒ± g√ºncelle (D√úZELTME: Doƒüru form√ºller)
        function updateLeverageCalculations() {
            const coinAmount = parseFloat(document.getElementById('coinAmount').value) || 0;
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const currentPrice = parseFloat(currentCoinPrice) || 0;

            if (currentPrice > 0) {
                let investedAmount = 0;
                let positionSize = 0;

                if (coinAmount > 0) {
                    // Coin miktarƒ±ndan yatƒ±rƒ±m hesapla
                    const totalPositionValue = coinAmount * currentPrice;
                    investedAmount = totalPositionValue / currentLeverage;
                    positionSize = coinAmount;
                } else if (totalAmount > 0) {
                    // Toplam tutardan pozisyon hesapla
                    investedAmount = totalAmount;
                    const totalPositionValue = totalAmount * currentLeverage;
                    positionSize = totalPositionValue / currentPrice;
                }

                // Liquidation price hesapla (D√úZELTME: Doƒüru form√ºl)
                const liquidationPercentage = 0.8; // %80 zarar durumunda liquidation
                const marginCallThreshold = liquidationPercentage / currentLeverage;
                let liquidationPrice = 0;
                
                if (currentPositionType === 'long') {
                    // Long: Fiyat d√º≈üt√ºƒü√ºnde liquidation
                    liquidationPrice = currentPrice * (1 - marginCallThreshold);
                } else {
                    // Short: Fiyat y√ºkseldiƒüinde liquidation
                    liquidationPrice = currentPrice * (1 + marginCallThreshold);
                }

                // Potansiyel kar/zarar hesapla
                const potentialPnL = calculatePotentialPnL(investedAmount, currentPrice, liquidationPrice);

                // UI'yƒ± g√ºncelle
                document.getElementById('leverageRatio').textContent = currentLeverage + 'x';
                document.getElementById('positionSize').textContent = positionSize.toFixed(8) + ' ' + currentCoinSymbol;
                document.getElementById('liquidationPrice').textContent = '‚Ç∫' + liquidationPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('investedAmount').textContent = '‚Ç∫' + investedAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                
                // Risk uyarƒ±sƒ± ekle
                const riskPercentage = (Math.abs(currentPrice - liquidationPrice) / currentPrice) * 100;
                updateRiskIndicator(riskPercentage);
            }
        }
        
        // Potansiyel kar/zarar hesaplama fonksiyonu
        function calculatePotentialPnL(investedAmount, entryPrice, targetPrice) {
            const priceChangePercentage = (targetPrice - entryPrice) / entryPrice;
            let pnl = 0;
            
            if (currentPositionType === 'long') {
                pnl = priceChangePercentage * investedAmount * currentLeverage;
            } else {
                pnl = -priceChangePercentage * investedAmount * currentLeverage;
            }
            
            return pnl;
        }
        
        // Risk g√∂stergesi g√ºncelle
        function updateRiskIndicator(riskPercentage) {
            const riskElement = document.getElementById('riskIndicator');
            if (!riskElement) return;
            
            let riskLevel = 'low';
            let riskColor = '#10b981';
            let riskText = 'D√º≈ü√ºk Risk';
            
            if (riskPercentage < 5) {
                riskLevel = 'high';
                riskColor = '#ef4444';
                riskText = 'Y√ºksek Risk - Liquidation Yakƒ±n!';
            } else if (riskPercentage < 15) {
                riskLevel = 'medium';
                riskColor = '#f59e0b';
                riskText = 'Orta Risk';
            }
            
            riskElement.style.color = riskColor;
            riskElement.textContent = `${riskText} (${riskPercentage.toFixed(1)}%)`;
        }

        // Pozisyonlarƒ± y√ºkle
        async function loadPositions() {
            try {
                const response = await fetch('backend/user/leverage_trading.php?action=positions', {
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (data.success) {
                    // Pozisyonlarƒ± global deƒüi≈ükende sakla
                    window.currentPositions = data.positions;
                    displayPositions(data.positions);
                    updatePositionStats(data.positions);
                } else {
                    throw new Error(data.error || 'Pozisyonlar y√ºklenemedi');
                }
            } catch (error) {
                console.error('Pozisyon y√ºkleme hatasƒ±:', error);
                document.getElementById('positionsTable').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Pozisyonlar y√ºklenirken hata olu≈ütu</span>
                        <br>
                        <small>Hata: ${error.message}</small>
                    </div>
                `;
            }
        }

        // Pozisyonlarƒ± g√∂r√ºnt√ºle - D√úZELTME: Kullanƒ±cƒ± dostu pozisyon kapatma
        function displayPositions(positions) {
            const container = document.getElementById('positionsTable');
            
            if (positions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Hen√ºz Pozisyon Yok</h3>
                        <p>Kaldƒ±ra√ßlƒ± i≈ülem yapmak i√ßin piyasalar sayfasƒ±ndan coin se√ßip kaldƒ±ra√ßlƒ± mod ile i≈ülem yapabilirsiniz</p>
                        <button class="btn-primary" onclick="showSection('markets')">
                            <i class="fas fa-plus"></i>
                            ƒ∞lk Pozisyonu A√ß
                        </button>
                    </div>
                `;
                return;
            }

            let positionsHTML = `
                <div class="modern-positions-container">
            `;

            positions.forEach(position => {
                const pnlClass = position.unrealized_pnl >= 0 ? 'positive' : 'negative';
                const pnlSign = position.unrealized_pnl >= 0 ? '+' : '';
                const pnlPercentage = parseFloat(position.pnl_percentage || 0).toFixed(1);
                const currentPrice = parseFloat(position.market_price || position.current_price);
                const entryPrice = parseFloat(position.entry_price);
                const priceChangePercent = ((currentPrice - entryPrice) / entryPrice * 100).toFixed(2);
                const priceChangeClass = currentPrice >= entryPrice ? 'positive' : 'negative';
                
                // Risk seviyesi hesapla
                const liquidationPrice = parseFloat(position.liquidation_price || 0);
                let riskLevel = 'low';
                let riskColor = '#10b981';
                let riskText = 'D√º≈ü√ºk Risk';
                
                if (liquidationPrice > 0) {
                    const distanceToLiquidation = Math.abs(currentPrice - liquidationPrice) / currentPrice * 100;
                    if (distanceToLiquidation < 5) {
                        riskLevel = 'critical';
                        riskColor = '#ef4444';
                        riskText = 'KRƒ∞Tƒ∞K Rƒ∞SK!';
                    } else if (distanceToLiquidation < 15) {
                        riskLevel = 'high';
                        riskColor = '#f59e0b';
                        riskText = 'Y√ºksek Risk';
                    } else if (distanceToLiquidation < 30) {
                        riskLevel = 'medium';
                        riskColor = '#3b82f6';
                        riskText = 'Orta Risk';
                    }
                }
                
                positionsHTML += `
                    <div class="modern-position-card ${position.position_type} risk-${riskLevel}">
                        <!-- Risk Uyarƒ±sƒ± -->
                        ${riskLevel === 'critical' ? `
                        <div class="risk-warning critical">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>LIQUIDATION Rƒ∞SKƒ∞! Pozisyonu kapatmayƒ± d√º≈ü√ºn√ºn</span>
                        </div>
                        ` : ''}
                        
                        <div class="position-main-info">
                            <div class="coin-section">
                                <div class="coin-icon">
                                    <i class="fab fa-bitcoin"></i>
                                </div>
                                <div class="coin-details">
                                    <h3 class="coin-name">${position.coin_symbol}</h3>
                                    <div class="position-type ${position.position_type}">
                                        <i class="fas fa-arrow-${position.position_type === 'long' ? 'up' : 'down'}"></i>
                                        <span>${position.position_type === 'long' ? 'LONG' : 'SHORT'} ${position.leverage_ratio}x</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pnl-section ${pnlClass}">
                                <div class="pnl-amount">
                                    ${pnlSign}‚Ç∫${Math.abs(parseFloat(position.unrealized_pnl)).toLocaleString('tr-TR', {minimumFractionDigits: 0})}
                                </div>
                                <div class="pnl-percentage">
                                    ${pnlSign}${pnlPercentage}%
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fiyat Bilgileri -->
                        <div class="price-info-section">
                            <div class="price-row">
                                <span class="price-label">Giri≈ü Fiyatƒ±:</span>
                                <span class="price-value">‚Ç∫${entryPrice.toLocaleString('tr-TR', {minimumFractionDigits: 0})}</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">G√ºncel Fiyat:</span>
                                <span class="price-value ${priceChangeClass}">
                                    ‚Ç∫${currentPrice.toLocaleString('tr-TR', {minimumFractionDigits: 0})}
                                    <small>(${priceChangePercent >= 0 ? '+' : ''}${priceChangePercent}%)</small>
                                </span>
                            </div>
                            ${liquidationPrice > 0 ? `
                            <div class="price-row liquidation">
                                <span class="price-label">Liquidation:</span>
                                <span class="price-value" style="color: ${riskColor};">‚Ç∫${liquidationPrice.toLocaleString('tr-TR', {minimumFractionDigits: 0})}</span>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="position-stats">
                            <div class="stat-item">
                                <span class="stat-label">Yatƒ±rƒ±m</span>
                                <span class="stat-value">‚Ç∫${parseFloat(position.invested_amount).toLocaleString('tr-TR', {minimumFractionDigits: 0})}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Pozisyon B√ºy√ºkl√ºƒü√º</span>
                                <span class="stat-value">${parseFloat(position.position_size || 0).toFixed(6)} ${position.coin_symbol}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Risk Seviyesi</span>
                                <span class="stat-value" style="color: ${riskColor};">${riskText}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">A√ßƒ±lƒ±≈ü Zamanƒ±</span>
                                <span class="stat-value">${new Date(position.created_at).toLocaleDateString('tr-TR')}</span>
                            </div>
                        </div>
                        
                        <div class="position-chart">
                            <div class="mini-chart-container" id="miniChart_${position.id}_${position.coin_symbol}"></div>
                        </div>
                        
                        <!-- Geli≈ümi≈ü Pozisyon Kapatma Butonlarƒ± -->
                        <div class="position-actions-enhanced">
                            <div class="action-buttons-row">
                                <button class="btn-close-position quick-close" 
                                        onclick="quickClosePosition(${position.id}, '${position.coin_symbol}', ${currentPrice}, 'market')"
                                        title="Mevcut piyasa fiyatƒ±ndan hemen kapat">
                                    <i class="fas fa-bolt"></i>
                                    <span>Hƒ±zlƒ± Kapat</span>
                                    <small>Piyasa Fiyatƒ±</small>
                                </button>
                                
                                <button class="btn-close-position advanced-close" 
                                        onclick="openAdvancedCloseModal(${position.id}, '${position.coin_symbol}', ${currentPrice}, ${entryPrice}, ${position.leverage_ratio})"
                                        title="Geli≈ümi≈ü kapatma se√ßenekleri">
                                    <i class="fas fa-cog"></i>
                                    <span>Geli≈ümi≈ü Kapat</span>
                                    <small>Limit/Stop</small>
                                </button>
                            </div>
                            
                            <!-- Hƒ±zlƒ± Kar Al / Zarar Durdur -->
                            <div class="quick-actions-row">
                                <button class="btn-quick-action take-profit" 
                                        onclick="setQuickTakeProfit(${position.id}, ${currentPrice}, ${position.position_type})"
                                        title="Hƒ±zlƒ± kar al emri">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>Kar Al</span>
                                </button>
                                
                                <button class="btn-quick-action stop-loss" 
                                        onclick="setQuickStopLoss(${position.id}, ${currentPrice}, ${position.position_type})"
                                        title="Hƒ±zlƒ± zarar durdur emri">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>Zarar Durdur</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            positionsHTML += `
                </div>
            `;

            container.innerHTML = positionsHTML;

            // K√º√ß√ºk candlestick grafiklerini olu≈ütur
            createMiniCandlestickCharts(positions);

            // Candlestick coin listesini g√ºncelle
            updateCandlestickCoinList();
        }

        // Pozisyon istatistiklerini g√ºncelle (D√úZELTME: Doƒüru hesaplamalar)
        function updatePositionStats(positions) {
            const totalPositions = positions.length;
            const totalInvested = positions.reduce((sum, pos) => sum + parseFloat(pos.invested_amount), 0);
            const totalUnrealizedPnL = positions.reduce((sum, pos) => sum + parseFloat(pos.unrealized_pnl), 0);
            
            // Toplam pozisyon deƒüeri (yatƒ±rƒ±m + kar/zarar)
            const totalPositionValue = totalInvested + totalUnrealizedPnL;
            
            // Kar/zarar y√ºzdesi
            const pnlPercentage = totalInvested > 0 ? (totalUnrealizedPnL / totalInvested) * 100 : 0;

            document.getElementById('totalPositions').textContent = totalPositions;
            document.getElementById('totalInvested').textContent = '‚Ç∫' + totalInvested.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            const pnlElement = document.getElementById('totalUnrealizedPnL');
            const pnlSign = totalUnrealizedPnL >= 0 ? '+' : '';
            pnlElement.textContent = pnlSign + '‚Ç∫' + Math.abs(totalUnrealizedPnL).toLocaleString('tr-TR', {minimumFractionDigits: 2});
            pnlElement.className = 'stat-value ' + (totalUnrealizedPnL >= 0 ? 'positive' : 'negative');

            // Kar/zarar y√ºzdesini g√ºncelle
            const pnlPercentageElement = document.getElementById('pnlPercentage');
            if (pnlPercentageElement) {
                pnlPercentageElement.textContent = `${pnlSign}${Math.abs(pnlPercentage).toFixed(2)}%`;
                pnlPercentageElement.className = 'stat-change ' + (totalUnrealizedPnL >= 0 ? 'positive' : 'negative');
            }

            // En iyi pozisyonu bul
            if (positions.length > 0) {
                const bestPosition = positions.reduce((best, current) => {
                    const currentPnL = parseFloat(current.unrealized_pnl);
                    const bestPnL = parseFloat(best.unrealized_pnl);
                    return currentPnL > bestPnL ? current : best;
                });
                
                const bestPositionValueElement = document.getElementById('bestPositionValue');
                const bestPositionChangeElement = document.getElementById('bestPositionChange');
                
                if (bestPositionValueElement && bestPositionChangeElement) {
                    bestPositionValueElement.textContent = bestPosition.coin_symbol;
                    const bestPnL = parseFloat(bestPosition.unrealized_pnl);
                    const bestPnLPercentage = parseFloat(bestPosition.pnl_percentage || 0);
                    bestPositionChangeElement.textContent = `${bestPnL >= 0 ? '+' : ''}‚Ç∫${Math.abs(bestPnL).toLocaleString('tr-TR')} (${bestPnL >= 0 ? '+' : ''}${bestPnLPercentage.toFixed(1)}%)`;
                    bestPositionChangeElement.style.color = bestPnL >= 0 ? '#10b981' : '#ef4444';
                }
            }

            // Pozisyon sayƒ±sƒ±nƒ± nav men√ºs√ºnde g√∂ster
            const positionCount = document.getElementById('positionCount');
            if (totalPositions > 0) {
                positionCount.textContent = totalPositions;
                positionCount.style.display = 'flex';
            } else {
                positionCount.style.display = 'none';
            }
        }
